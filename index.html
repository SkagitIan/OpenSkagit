<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#f08000" />
  <title>OpenSkagit — Chat with Local Data (PWA)</title>

  <!-- Tailwind (CDN for prototype) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

  <style>
    /* Brand tokens */
    :root{
      /* Darker palette for stronger contrast */
      --osg-purple:#8A63A5; /* user bubble */
      --osg-slate:#2E2B3A;  /* assistant bubble */
      --osg-orange:#D16900; /* accents */
      --osg-dark:#0E050C;   /* headers */
      --osg-teal:#2C8C7A;   /* success */
      --radius-xl: 16px;
      --shadow-soft: 0 8px 28px rgba(0,0,0,.08);
    }
    /* Global typography */
    html{ font-size:18px; }
    body{
      font-size:1rem;
      line-height:1.7;
      letter-spacing:0.015em;
      color:var(--osg-dark);
    }
    p,li{ margin-bottom:1em; }
    input,button,textarea{ font-size:1rem; line-height:1.5; }
    .text-sm{ font-size:1rem !important; }
    .text-xs,[class*="text-[11px]"]{ font-size:0.875rem !important; }
    #chat{ gap:1.5rem !important; }
    .card{ box-shadow: var(--shadow-soft); border-radius: var(--radius-xl); padding:1.25rem !important; }
    .chip{ border-radius: 9999px; }

    /* Header bling — animated accent bar */
    @keyframes osg-shift { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
    .animated-bar{ background-image: linear-gradient(90deg,var(--osg-purple),var(--osg-teal),var(--osg-orange)); background-size:200% 200%; animation: osg-shift 8s linear infinite; }

    /* Background vibe similar to ChatGPT: soft radial + subtle grid */
    .bg-vibe{
      background:
        radial-gradient(1200px 600px at 50% -200px, rgba(185,147,214,.18), transparent 70%),
        radial-gradient(800px 400px at 10% 20%, rgba(88,176,156,.10), transparent 70%),
        radial-gradient(800px 400px at 90% 10%, rgba(240,128,0,.08), transparent 70%),
        linear-gradient(transparent 0, transparent 100%),
        repeating-linear-gradient(0deg, rgba(20,8,14,.035), rgba(20,8,14,.035) 1px, transparent 1px, transparent 24px),
        repeating-linear-gradient(90deg, rgba(20,8,14,.035), rgba(20,8,14,.035) 1px, transparent 1px, transparent 24px);
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-50 via-teal-50 to-orange-50 text-neutral-900 bg-vibe">

  <!-- Fixed, full-width header (ChatGPT-ish) -->
  <header class="mb-8">
    <div class="h-1.5 animated-bar"></div>
    <div class="backdrop-blur supports-[backdrop-filter]:bg-white/70 bg-white/90 border-b border-neutral-200/70">
      <div class="mx-auto max-w-5xl px-4 sm:px-6 lg:px-8">
        <div class="h-16 flex items-center justify-between gap-4">
          <!-- Brand -->
          <a href="#" class="flex items-center gap-3">
            <div class="h-9 w-9 rounded-xl bg-[var(--osg-purple)]"></div>
            <div>
              <span class="block text-lg font-semibold text-[var(--osg-dark)] leading-tight">OpenSkagit</span>
              <span class="block text-[11px] text-neutral-500 -mt-0.5">Ask the record. Get the receipts.</span>
            </div>
          </a>

          <!-- Inline newsletter (localStorage only; optional CF hook) -->
          <form id="newsletter" class="hidden md:flex items-center gap-2" aria-label="Newsletter signup">
            <input type="email" name="email" required autocomplete="email" inputmode="email"
                   class="h-9 w-56 rounded-xl border border-neutral-300 bg-white px-3 text-sm placeholder:text-neutral-400 focus:outline-none focus:ring-2 focus:ring-[var(--osg-purple)]"
                   placeholder="you@example.com" aria-label="Email address"/>
            <button class="h-9 inline-flex items-center gap-2 rounded-xl bg-[var(--osg-orange)] px-3.5 text-white text-sm font-semibold shadow hover:opacity-95">
              <i class="fa-regular fa-bell"></i><span>Subscribe</span>
            </button>
            <span id="nl-msg" class="text-xs text-neutral-600"></span>
          </form>

          <!-- Right-side actions -->
          <div class="flex items-center gap-2"><button id="settings-btn" aria-label="Settings" class="grid h-9 w-9 place-items-center rounded-xl border border-neutral-300 bg-white text-sm hover:bg-neutral-50">
              <i class="fa-solid fa-gear"></i>
            </button>
            
            <button id="new-chat" class="inline-flex items-center gap-2 rounded-xl bg-[var(--osg-orange)] px-3.5 h-9 text-white text-sm font-semibold shadow hover:opacity-95">
              <i class="fa-regular fa-message"></i><span class="hidden sm:inline">New Chat</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Main page container (centered composer) -->
  <div class="mx-auto max-w-3xl px-4 sm:px-6 lg:px-8 min-h-screen flex flex-col justify-center">

    <!-- Chat thread at top -->
    <main id="chat" class="grid gap-4 mb-6" role="list" aria-label="Chat thread"></main>

    <!-- Composer centered -->
    <footer>
      <div class="card bg-white p-2 border border-neutral-200">
        <!-- Mode toggle on top edge -->
        <fieldset class="mb-1 flex items-center gap-1 px-2" aria-label="Answer mode">
          <input type="radio" name="mode" id="mode-concise" value="concise" class="peer/con hidden" checked>
          <label for="mode-concise" class="peer-checked/con:bg-[var(--osg-orange)] peer-checked/con:text-white rounded-lg px-2.5 py-1 text-xs cursor-pointer border border-[var(--osg-orange)]/30">Concise</label>
          <input type="radio" name="mode" id="mode-detailed" value="detailed" class="peer/det hidden">
          <label for="mode-detailed" class="peer-checked/det:bg-[var(--osg-orange)] peer-checked/det:text-white rounded-lg px-2.5 py-1 text-xs cursor-pointer border border-[var(--osg-orange)]/30">Detailed</label>
          <input type="radio" name="mode" id="mode-sources" value="sources_only" class="peer/src hidden">
          <label for="mode-sources" class="peer-checked/src:bg-[var(--osg-orange)] peer-checked/src:text-white rounded-lg px-2.5 py-1 text-xs cursor-pointer border border-[var(--osg-orange)]/30">Sources</label>
          <span class="ml-auto text-[11px] text-neutral-500">Enter = send • Shift+Enter = newline</span>
        </fieldset>

        <form id="composer" class="flex items-end gap-2">
          <textarea id="prompt" rows="2" required
            class="flex-1 rounded-2xl border border-neutral-200 bg-white px-4 py-3 focus:outline-none focus:ring-2 focus:ring-[var(--osg-purple)] placeholder:text-neutral-400"
            placeholder="Ask about meetings, ordinances, parcels, or keywords…"></textarea>
          <button id="send" type="submit" class="grid h-11 w-11 place-items-center rounded-2xl bg-[var(--osg-orange)] text-white shadow hover:opacity-95">
            <i class="fa-solid fa-paper-plane"></i>
          </button>
        </form>
      </div>
    </footer>

    <!-- Conversation starters under chat box -->
    <section id="starters" class="mt-6">
      <div class="flex flex-wrap gap-2 justify-center">
        <button data-prompt="What changed in last night’s council agenda?" class="chip bg-gradient-to-r from-[var(--osg-purple)]/20 via-[var(--osg-teal)]/20 to-[var(--osg-orange)]/20 border border-[var(--osg-orange)]/30 text-[var(--osg-dark)] px-3 py-1.5 text-sm hover:opacity-80">What changed in last night’s council agenda?</button>
        <button data-prompt="Summarize mentions of ‘Roundabout’ in 2025." class="chip bg-gradient-to-r from-[var(--osg-purple)]/20 via-[var(--osg-teal)]/20 to-[var(--osg-orange)]/20 border border-[var(--osg-orange)]/30 text-[var(--osg-dark)] px-3 py-1.5 text-sm hover:opacity-80">Summarize mentions of ‘Roundabout’ in 2025.</button>
        <button data-prompt="Show references to ‘stormwater fees’ in the last 90 days." class="chip bg-gradient-to-r from-[var(--osg-purple)]/20 via-[var(--osg-teal)]/20 to-[var(--osg-orange)]/20 border border-[var(--osg-orange)]/30 text-[var(--osg-dark)] px-3 py-1.5 text-sm hover:opacity-80">‘Stormwater fees’ last 90 days</button>
        <button data-prompt="Which parcels were discussed in the 2025‑08‑12 planning meeting?" class="chip bg-gradient-to-r from-[var(--osg-purple)]/20 via-[var(--osg-teal)]/20 to-[var(--osg-orange)]/20 border border-[var(--osg-orange)]/30 text-[var(--osg-dark)] px-3 py-1.5 text-sm hover:opacity-80">Parcels in 8/12 planning mtg</button>
      </div>
    </section>

  </div>

  <!-- Settings Modal -->
  <div id="settings-modal" class="fixed inset-0 z-50 hidden">
    <div class="flex h-full w-full items-center justify-center bg-black/50">
      <div class="card w-96 bg-white p-6">
        <h2 class="text-lg font-semibold mb-4">Settings</h2>
        <label for="llm-instructions" class="block text-sm font-medium mb-1">Special instructions for LLM</label>
        <textarea id="llm-instructions" rows="3" class="w-full rounded-lg border border-neutral-300 p-2 text-sm mb-4" placeholder="e.g., Answer with bullet points"></textarea>
        <button id="clear-cache" class="w-full mb-4 rounded-lg border border-neutral-300 bg-white px-3 py-2 text-sm hover:bg-neutral-50">Clear Cache</button>
        <p class="text-xs text-neutral-500 mb-4">Future settings coming soon.</p>
        <div class="flex justify-end gap-2">
          <button id="settings-cancel" class="rounded-lg border border-neutral-300 bg-white px-3 py-1.5 text-sm hover:bg-neutral-50">Cancel</button>
          <button id="settings-save" class="rounded-lg bg-[var(--osg-orange)] px-3 py-1.5 text-sm text-white hover:opacity-95">Save</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ===== PWA manifest (no extra file) ===== */
    (function attachManifest(){
      const manifest = {
        name: "OpenSkagit",
        short_name: "OpenSkagit",
        start_url: ".",
        display: "standalone",
        background_color: "#ffffff",
        theme_color: "#f08000",
        icons: [
          { src: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='192' height='192'><rect width='100%' height='100%' fill='%23B993D6'/><text x='50%' y='55%' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='96' fill='white'>OS</text></svg>", sizes: "192x192", type: "image/svg+xml" },
          { src: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='512' height='512'><rect width='100%' height='100%' fill='%23f08000'/><text x='50%' y='55%' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='220' fill='white'>OS</text></svg>", sizes: "512x512", type: "image/svg+xml" }
        ]
      };
      const blob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
      const link = document.createElement('link');
      link.rel = 'manifest';
      link.href = URL.createObjectURL(blob);
      document.head.appendChild(link);
    })();

    /* ===== SAFE Service Worker registration =====
       - Only attempt in secure context (https or localhost)
       - Only attempt if browser supports it
       - Only attempt if sw.js appears to exist
       - Never throw; fail silently (log info only)
    ============================================ */
    (async function registerSWSafely(){
      try{
        if(!('serviceWorker' in navigator)) return console.info('[PWA] SW not supported; skipping');
        const secure = window.isSecureContext || location.hostname === 'localhost';
        if(!secure) return console.info('[PWA] Insecure context; skipping SW');
        // Check if sw.js is reachable before registering
        const probe = await fetch('sw.js', { method: 'GET', cache: 'no-store' });
        if(!probe.ok){
          console.info('[PWA] sw.js not found; skipping SW');
          return; // graceful skip
        }
        const reg = await navigator.serviceWorker.register('sw.js');
        console.info('[PWA] SW registered:', reg.scope);
      }catch(e){
        // Graceful: do not surface as an error; just inform in console
        console.info('[PWA] SW registration skipped (env restriction):', e && e.message);
      }
    })();

    /* ===== Local JSON storage (no backend) ===== */
    const STORAGE_KEY = 'osg_chats_v1';
    const chats = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');

    // Elements
    const chat = document.getElementById('chat');
    const promptEl = document.getElementById('prompt');
    const starters = document.getElementById('starters');
    const nlForm = document.getElementById('newsletter');
    const nlMsg  = document.getElementById('nl-msg');

    // Cloud Function proxy for OpenAI requests
    const PROXY_URL = 'https://openai-proxy-810345357173.us-west1.run.app';

    async function loadStarters(){
      if (chats.length !== 0) return;
      try {
        console.log("[loadStarters] sending request to", PROXY_URL);
    
        const body = {
          model: "gpt-4o-mini",
          input: "List four short example questions a citizen might ask about local government data."
        };
        console.log("[loadStarters] request body:", body);
    
        const res = await fetch(PROXY_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(body)
        });
    
        console.log("[loadStarters] raw response object:", res);
    
        // log status + headers
        console.log("[loadStarters] status:", res.status, res.statusText);
        res.headers.forEach((v, k) => console.log("[loadStarters] header:", k, "=", v));
    
        let dataText;
        try {
          dataText = await res.text(); // capture raw body first
          console.log("[loadStarters] raw response text:", dataText);
        } catch (e) {
          console.error("[loadStarters] error reading response text:", e);
        }
    
        let data = {};
        try {
          data = JSON.parse(dataText);
        } catch (e) {
          console.error("[loadStarters] error parsing JSON:", e);
        }
    
        console.log("[loadStarters] parsed JSON:", data);
    
        const text = data.output_text || "";
        console.log("[loadStarters] output_text field:", text);
    
        const prompts = text
          .split("\n")
          .map(s => s.replace(/^[\s\d\-\*\.]+/, "").trim())
          .filter(Boolean)
          .slice(0, 4);
    
        console.log("[loadStarters] extracted prompts:", prompts);
    
        if (prompts.length) {
          const box = starters.querySelector("div");
          if (!box) {
            console.error("[loadStarters] no div inside #starters found");
            return;
          }
          box.innerHTML = "";
          prompts.forEach(p => {
            const b = document.createElement("button");
            b.dataset.prompt = p;
            b.className =
              "chip bg-gradient-to-r from-[var(--osg-purple)]/20 via-[var(--osg-teal)]/20 to-[var(--osg-orange)]/20 border border-[var(--osg-orange)]/30 text-[var(--osg-dark)] px-3 py-1.5 text-sm hover:opacity-80";
            b.textContent = p;
            box.appendChild(b);
          });
        } else {
          console.warn("[loadStarters] no prompts extracted from output_text");
        }
      } catch (err) {
        console.error("[loadStarters] unexpected exception:", err);
      }
    }
loadStarters()

    // Optional: Cloud Function endpoint for newsletter (leave blank to skip)
    const CF_ENDPOINT = '';

    // Render existing messages
    chats.forEach(msg => renderBubble(msg.role, msg.content));

    // New Chat clears local state
    document.getElementById('new-chat').addEventListener('click', () => {
      localStorage.setItem(STORAGE_KEY, '[]');
      chat.innerHTML = '';
      promptEl.value = '';
      starters.classList.remove('hidden');
      promptEl.focus();
    });

    // Starters → fill + send
    starters.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-prompt]');
      if(!btn) return;
      promptEl.value = btn.dataset.prompt;
      submitComposer(new Event('submit'));
    });

    // Keyboard helper
    document.addEventListener('keydown', (e) => {
      const metaEnter = (e.metaKey || e.ctrlKey) && e.key === 'Enter';
      if (metaEnter) { e.preventDefault(); document.getElementById('send').click(); }
    });

    // Composer submit (calls Cloud Function proxy)
    document.getElementById('composer').addEventListener('submit', submitComposer);

    async function submitComposer(e){
      if(e) e.preventDefault();
      const text = promptEl.value.trim();
      if(!text) return;

      const instructions = localStorage.getItem('osg_instructions') || '';

      // Hide starters on first send
      starters.classList.add('hidden');

      // Persist + render user
      pushMessage({role:'user', content:text});
      renderBubble('user', text);

      // Clear input
      promptEl.value = '';
      promptEl.focus();

      const mode = document.querySelector('input[name="mode"]:checked').value;

      // Show placeholder while fetching
      const placeholder = renderBubble('assistant', '…');
      const body = placeholder.querySelector('div');
      window.scrollTo({top: document.body.scrollHeight, behavior: 'smooth'});

      try{
        const history = chats.map(({role, content}) => ({role, content}));
        const messages = [...history];

        // Apply mode + custom instructions
        let modeInstruction = '';
        if(mode === 'detailed') modeInstruction = 'Provide a detailed answer.';
        else if(mode === 'sources_only') modeInstruction = 'Only list relevant sources. Do not answer the question.';
        else modeInstruction = 'Provide a concise answer.';
        if(modeInstruction) messages.unshift({role:'system', content: modeInstruction});
        if(instructions) messages.unshift({role:'system', content: instructions});

        const res = await fetch(PROXY_URL, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({
            model: 'gpt-4o-mini',
            input: [
              ...history.map(h => ({role: h.role, content: h.content})),
              {role: "user", content: text}
            ]
          })
        });

        const data = await res.json();
        const reply = data.output?.[0]?.content?.[0]?.text?.trim() || "";
        pushMessage({role:'assistant', content:reply});
        body.textContent = reply || '[No response]';
      }catch(err){
        body.textContent = `Error: ${err.message}`;
      }
    }

    function pushMessage(m){
      chats.push({ ...m, ts: new Date().toISOString() });
      localStorage.setItem(STORAGE_KEY, JSON.stringify(chats));
    }

    function renderBubble(role, html, isHTML){
      const a = document.createElement('article');
      a.className = role==='user' ? 'card bg-[var(--osg-purple)] text-black/90 p-4' : 'card bg-[var(--osg-slate)] text-white p-4';
      a.setAttribute('role','listitem');
      const body = document.createElement('div');
      body.className = role==='user' ? 'whitespace-pre-wrap' : 'prose prose-invert max-w-none';
      body.innerHTML = isHTML ? html : escapeHtml(html);
      a.appendChild(body);

      if(role==='assistant'){
        const bar = document.createElement('div');
        bar.className = 'mt-2 flex items-center gap-2';
        bar.innerHTML = `
          <button class="rounded-lg bg-white/10 px-3 py-1.5 text-sm hover:bg-white/15" data-feedback="up">👍</button>
          <button class="rounded-lg bg-white/10 px-3 py-1.5 text-sm hover:bg-white/15" data-feedback="down">👎</button>
          <button class="rounded-lg bg-white/10 px-3 py-1.5 text-sm hover:bg-white/15" data-copy>Copy</button>`;
        a.appendChild(bar);
        bar.querySelector('[data-copy]').addEventListener('click', async () => {
          await navigator.clipboard.writeText(a.innerText);
          const tag = document.createElement('span');
          tag.className = 'ml-2 text-xs';
          tag.style.color = 'var(--osg-teal)';
          tag.textContent = 'Copied';
          bar.appendChild(tag); setTimeout(()=>tag.remove(), 1200);
        });
      }

      chat.appendChild(a);
      return a;
    }

    function escapeHtml(str){
      return str.replace(/[&<>\"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[c]));
    }

    /* ===== Newsletter: local JSON + optional CF ===== */
    nlForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const email = new FormData(nlForm).get('email');
      const emails = JSON.parse(localStorage.getItem('osg_newsletter')||'[]');
      if(!emails.includes(email)) emails.push(email);
      localStorage.setItem('osg_newsletter', JSON.stringify(emails));
      nlMsg.textContent = 'Subscribed'; nlMsg.style.color = 'var(--osg-teal)';
      try{
        if(CF_ENDPOINT){ await fetch(CF_ENDPOINT,{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({email})}); }
      }catch(err){ console.info('[PWA] Optional CF post failed:', err && err.message); }
      nlForm.reset();
      setTimeout(()=>{ nlMsg.textContent=''; }, 1500);
    });

    // ===== Settings =====
    const settingsBtn = document.getElementById('settings-btn');
    const settingsModal = document.getElementById('settings-modal');
    const instructionsInput = document.getElementById('llm-instructions');
    const settingsSave = document.getElementById('settings-save');
    const settingsCancel = document.getElementById('settings-cancel');
    const clearCacheBtn = document.getElementById('clear-cache');

    settingsBtn.addEventListener('click', () => {
      instructionsInput.value = localStorage.getItem('osg_instructions') || '';
      settingsModal.classList.remove('hidden');
    });

    settingsCancel.addEventListener('click', () => {
      settingsModal.classList.add('hidden');
    });

    settingsSave.addEventListener('click', () => {
      localStorage.setItem('osg_instructions', instructionsInput.value.trim());
      settingsModal.classList.add('hidden');
    });

    settingsModal.addEventListener('click', (e) => {
      if(e.target === settingsModal) settingsModal.classList.add('hidden');
    });

    clearCacheBtn.addEventListener('click', async () => {
      localStorage.clear();
      if('caches' in window){
        const keys = await caches.keys();
        await Promise.all(keys.map(k => caches.delete(k)));
      }
      location.reload();
    });

    /* ===== Minimal self-tests (dev diagnostics) =====
       These run in the browser console and update the page if ?test=1 is in the URL.
    */
    (function runSelfTests(){
      const url = new URL(location.href);
      if(url.searchParams.get('test') !== '1') return;
      const tests = [];
      const add = (name, fn) => tests.push({name, fn});

      add('Does not throw when SW unsupported', () => {
        // Simulate by checking feature flag; no exception expected from registerSWSafely path
        return typeof navigator !== 'undefined' && typeof navigator.serviceWorker !== 'undefined' ? 'N/A (supported)' : 'PASS';
      });

      add('Skips SW in insecure context', () => (window.isSecureContext || location.hostname==='localhost') ? 'N/A (secure)' : 'PASS');
      add('LocalStorage chat write/read', () => {
        const key = 'osg_test';
        localStorage.setItem(key, JSON.stringify({ok:true}));
        const ok = JSON.parse(localStorage.getItem(key)||'{}').ok === true;
        localStorage.removeItem(key);
        return ok ? 'PASS' : 'FAIL';
      });

      // Render results inline for quick visibility
      const box = document.createElement('div');
      box.className = 'fixed bottom-20 right-4 z-50 rounded-xl bg-white/95 border border-neutral-200 shadow p-3 text-sm';
      box.innerHTML = '<div class="font-semibold mb-1">Diagnostics</div>';
      const ul = document.createElement('ul'); ul.className = 'list-disc pl-5';
      tests.forEach(t => {
        let res = 'PASS';
        try { const r = t.fn(); if(r!==undefined) res = r; } catch(e){ res = 'FAIL'; }
        const li = document.createElement('li');
        li.innerHTML = `<span class="font-medium">${t.name}:</span> <span class="${res==='PASS'?'text-[var(--osg-teal)]':'text-red-600'}">${res}</span>`;
        ul.appendChild(li);
      });
      box.appendChild(ul);
      document.body.appendChild(box);
    })();
  </script>
</body>
</html>
