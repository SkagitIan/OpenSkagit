{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Appertivo • Property Copilot</title>
  <link rel="stylesheet" href="{% static 'openskagit/chat.css' %}" />
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <script src="https://unpkg.com/alpinejs@3.13.8/dist/cdn.min.js" defer></script>
  <style>
    :root{
      --ap-purple:#B993D6;
      --ap-orange:#f08000;
      --ap-teal:#58B09C;
      --ap-ink:#49475B;
      --ap-black:#14080E;
    }
    [x-cloak]{display:none!important;}
    .thin-scroll::-webkit-scrollbar{width:8px;height:8px}
    .thin-scroll::-webkit-scrollbar-thumb{background:rgba(73,71,91,.25);border-radius:9999px}
    .msg pre{white-space:pre-wrap;word-break:break-word}
  </style>
</head>
<body x-data="{ sidebarOpen:false }"
      class="min-h-screen bg-neutral-100 text-neutral-900 selection:bg-[var(--ap-teal)]/20 selection:text-[var(--ap-black)]"
      data-chat-root
      data-chat-style="portal"
      data-send-url="{% url 'chat' %}"
      data-history-url="{% url 'chat-history' %}"
      data-new-url="{% url 'chat-new' %}"
      data-conversation-id="{{ conversation_id }}"
      data-initial-prompt="{{ initial_prompt|default:''|escape }}">

  <!-- Top navigation -->
  <header class="sticky top-0 z-40 border-b border-neutral-200 bg-white/95 backdrop-blur">
    <div class="mx-auto flex max-w-6xl items-center gap-3 px-4 py-4">
      <div class="flex items-center gap-2 text-lg font-semibold tracking-tight text-[var(--ap-ink)]">
        <span class="inline-flex h-9 w-9 items-center justify-center rounded-xl border border-[var(--ap-purple)]/60 bg-[var(--ap-purple)]/10 text-sm font-bold uppercase text-[var(--ap-purple)]">Ap</span>
        <span>Appertivo Property Copilot</span>
      </div>
      <div class="ml-auto flex items-center gap-3 text-sm text-neutral-500">
        <span class="hidden sm:inline">pgvector retrieval + OpenAI Responses</span>
        <button type="button"
                class="inline-flex items-center gap-2 rounded-full border border-neutral-200 px-3 py-1 text-sm font-medium text-[var(--ap-ink)] hover:border-[var(--ap-purple)] hover:text-[var(--ap-purple)] md:hidden"
                @click="sidebarOpen = true">
          <span class="h-2 w-2 rounded-full bg-[var(--ap-purple)]"></span>
          History
        </button>
      </div>
    </div>
  </header>

  <div class="relative mx-auto flex w-full max-w-7xl flex-1 flex-col md:flex-row">
    <!-- Overlay -->
    <div x-show="sidebarOpen"
         x-cloak
         class="fixed inset-0 z-40 bg-[var(--ap-black)]/40 backdrop-blur-sm md:hidden"
         @click="sidebarOpen = false"
         x-transition.opacity></div>

    <!-- Sidebar -->
    <aside x-cloak
           class="fixed inset-y-0 left-0 z-50 flex w-72 flex-col bg-white shadow-xl ring-1 ring-black/5 transition-transform duration-200 md:static md:z-0 md:translate-x-0 md:shadow-none"
           :class="sidebarOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'"
           @keydown.escape.window="sidebarOpen = false">
      <div class="flex h-full flex-col">
        <div class="border-b border-neutral-200 px-4 py-4">
          <div class="flex items-center justify-between gap-2">
            <h2 class="text-xs font-semibold uppercase tracking-wide text-neutral-500">Conversations</h2>
            <button type="button"
                    data-chat-reset
                    @click="sidebarOpen = false"
                    class="rounded-full bg-[var(--ap-purple)] px-3 py-1 text-xs font-semibold text-white hover:bg-[var(--ap-purple)]/90">
              New
            </button>
          </div>
        </div>
        <div class="flex-1 overflow-y-auto thin-scroll px-4 py-4">
          <div id="history" class="space-y-1 text-sm" data-chat-history>
            {% include "partials/history.html" with conversations=conversations active_id=conversation_id %}
          </div>

          <div class="mt-8 space-y-3 rounded-xl border border-neutral-200 bg-neutral-50 p-4">
            <div class="flex items-center gap-2 text-sm font-semibold text-[var(--ap-ink)]">
              <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-[var(--ap-teal)]/20 text-[var(--ap-teal)]">⇪</span>
              Staff document upload
            </div>
            <p class="text-xs text-neutral-500">
              Upload PDFs or CSVs and we’ll chunk, embed, and store them in Postgres with pgvector.
            </p>
            <form hx-post="/documents/upload/"
                  hx-target="#upload-status"
                  hx-swap="innerHTML"
                  hx-encoding="multipart/form-data"
                  hx-indicator="#upload-indicator"
                  class="space-y-3">
              {% csrf_token %}
              <div>
                <label class="sr-only" for="doc-file">Select documents</label>
                <input id="doc-file"
                       name="documents"
                       type="file"
                       multiple
                       class="w-full text-sm text-neutral-600 file:mr-4 file:rounded-lg file:border-0 file:bg-[var(--ap-teal)]/25 file:px-3 file:py-2 file:text-sm file:font-medium file:text-[var(--ap-ink)] hover:file:bg-[var(--ap-teal)]/35" />
              </div>
              <button type="submit"
                      class="w-full rounded-lg bg-[var(--ap-teal)] px-3 py-2 text-sm font-semibold text-[var(--ap-black)] hover:bg-[var(--ap-teal)]/90">
                Process &amp; embed
              </button>
            </form>
            <div id="upload-indicator" class="htmx-indicator text-xs text-neutral-500">Uploading…</div>
            <div id="upload-status" class="text-xs text-neutral-500">
              Awaiting upload.
            </div>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main column -->
    <main class="ml-auto flex w-full flex-1 flex-col bg-neutral-100 md:min-h-[calc(100vh-80px)]">
      <section id="messages-wrap" class="flex-1 overflow-y-auto px-4 py-6 md:px-10 md:py-10 thin-scroll" data-chat-scroll>
        <div class="mx-auto w-full max-w-3xl space-y-4" id="messages" data-chat-messages>
          {% if messages %}
            {% for m in messages %}
              {% include "partials/message.html" with role=m.role content=m.content sources=m.sources %}
            {% endfor %}
          {% else %}
            {% include "partials/empty_state.html" %}
          {% endif %}
        </div>
      </section>

      <footer class="border-t border-neutral-200 bg-gradient-to-t from-white to-white/95 backdrop-blur">
        <div class="mx-auto flex max-w-3xl flex-col gap-3 px-4 py-4">
          <form id="chat-form"
                data-chat-form
                class="flex items-end gap-3 rounded-2xl border-2 border-neutral-200 bg-white px-4 py-3 shadow-lg transition-all focus-within:border-[var(--ap-teal)] focus-within:shadow-xl focus-within:shadow-[var(--ap-teal)]/10">
            {% csrf_token %}
            {% if conversation_id %}
              <input type="hidden" name="conversation_id" value="{{ conversation_id }}" data-chat-conversation-input>
            {% else %}
              <input type="hidden" name="conversation_id" value="" data-chat-conversation-input>
            {% endif %}
            <div class="flex-1">
              <label class="sr-only" for="prompt">Ask a question</label>
              <textarea id="prompt"
                        name="prompt"
                        rows="1"
                        placeholder="Ask about parcels, comps, or uploaded PDFs…"
                        class="w-full resize-none bg-transparent px-2 py-2 text-sm text-[var(--ap-ink)] placeholder-neutral-400 focus:outline-none focus:ring-0"
                        oninput="this.style.height='auto';this.style.height=(this.scrollHeight)+'px'"
                        required></textarea>
            </div>
            <button type="submit"
                    class="inline-flex shrink-0 items-center gap-2 rounded-xl bg-gradient-to-r from-[var(--ap-teal)] to-[var(--ap-teal)]/90 px-5 py-2.5 text-sm font-bold text-white shadow-md transition-all hover:scale-105 hover:shadow-lg hover:shadow-[var(--ap-teal)]/30 focus:outline-none focus:ring-2 focus:ring-[var(--ap-teal)]/50 focus:ring-offset-2 active:scale-95">
              <span>Send</span>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-4 w-4 fill-none stroke-current stroke-2">
                <path d="M5 12h14"></path>
                <path d="M12 5l7 7-7 7"></path>
              </svg>
            </button>
          </form>
          <div class="flex flex-col gap-1 px-3 text-xs">
            <div class="flex items-center gap-2">
              <div class="h-1.5 w-1.5 rounded-full bg-[var(--ap-teal)] animate-pulse"></div>
              <span class="text-neutral-600 font-medium" data-chat-status>Ready when you are.</span>
            </div>
            <div class="text-red-600 font-medium" data-chat-error></div>
          </div>
          <p class="px-3 pb-2 text-[11px] text-neutral-500">
            Powered by <span class="font-semibold text-[var(--ap-teal)]">pgvector</span> semantic search and <span class="font-semibold text-[var(--ap-purple)]">OpenAI Responses</span>
          </p>
        </div>
      </footer>
    </main>
  </div>

  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <script src="{% static 'openskagit/chat.js' %}" defer></script>
</body>
</html>
