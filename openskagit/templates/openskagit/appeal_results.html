{% extends "openskagit/appeal_base.html" %}
{% load humanize formatting %}

{% block page_title %}Step 2 â€” Neighborhood Snapshot{% endblock %}
{% block header_title %}Assessment Review{% endblock %}
{% block header_teaser %}
We located your property and gathered neighborhood insights. Scroll through the key metrics before you review comparables.
{% endblock %}

{% block content %}
  <section class="card">
    <div class="step-header">
      <span class="icon">ðŸ“Š</span>
      Step 2 â€” Neighborhood Snapshot
    </div>
    <div class="summary-banner">
      <span>Looking good! âœ“</span>
      Your assessed value is higher than most nearby sales. Keep that gap in mind when appealing.
    </div>
    <h2>Your Property Details</h2>
    <div class="detail-card">
      {% if subject.metadata.assessed_value %}
        <strong>${{ subject.metadata.assessed_value|floatformat:0|intcomma }}</strong>
      {% else %}
        <strong>â€”</strong>
      {% endif %}
      <span>
        {{ subject.address|default:"Address unavailable" }}
        Â· Parcel {{ subject.parcel_number }}
      </span>
      <div class="property-grid">
        <div>
          <strong>{% if subject.bedrooms %}{{ subject.bedrooms|floatformat:"-1" }}{% else %}&mdash;{% endif %}</strong>
          <span>Bedrooms</span>
        </div>
        <div>
          <strong>
            {% if subject.living_area %}
              {{ subject.living_area|floatformat:0|intcomma }}
            {% else %}
              &mdash;
            {% endif %}
          </strong>
          <span>Living area (sq ft)</span>
        </div>
        <div>
          <strong>{{ subject_year_built|default:"â€”" }}</strong>
          <span>Year built</span>
        </div>
        <div>
          <strong>
            {% if subject.acres %}
              {{ subject.acres|floatformat:2 }}
            {% else %}
              &mdash;
            {% endif %}
          </strong>
          <span>Lot (acres)</span>
        </div>
      </div>
    </div>

    <h2 style="margin-top: 24px;">How you compare</h2>
    <div class="metric-row metric-positive">
      <div>
        <strong>Assessment vs. Market</strong>
        <p class="metric-caption">
          {% if neighborhood.sales_ratio %}
            About {{ neighborhood.sales_ratio|floatformat:2 }}% of nearby sales, higher than 5 of 6 comparables.
          {% else %}
            Insights are loading. Comparables will show where you land.
          {% endif %}
        </p>
      </div>
      <span class="metric-value">
        {% if neighborhood.sales_ratio %}
          {{ neighborhood.sales_ratio|floatformat:2 }}%
        {% else %}
          â€”
        {% endif %}
      </span>
    </div>
    <div class="metric-row">
      <div>
        <strong>Neighborhood Uniformity (COD)</strong>
        <p class="metric-caption">Lower scores mean steadier patterns across similar homes.</p>
      </div>
      <span class="metric-value">
        {% if neighborhood.cod %}
          {{ neighborhood.cod|floatformat:1 }}
        {% else %}
          â€”
        {% endif %}
      </span>
    </div>
    <div class="metric-row metric-warning">
      <div>
        <strong>Price Dispersion (PRD)</strong>
        <p class="metric-caption">Values near 1.00 signal consistency; higher may mean variance.</p>
      </div>
      <span class="metric-value">
        {% if neighborhood.prd %}
          {{ neighborhood.prd|floatformat:2 }}
        {% else %}
          â€”
        {% endif %}
      </span>
    </div>

    <div class="section-cta">
      <button id="comparables-button" class="cta-button" type="button" data-url="{{ comparables_url }}">
        View Comparable Sales â†’
      </button>
    </div>
    <div id="comparables-status" class="indicator">
      <svg viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" opacity="0.25" />
        <path d="M22 12a10 10 0 00-10-10" stroke="currentColor" stroke-width="3" stroke-linecap="round" />
      </svg>
      Gathering comparable sales...
    </div>
  </section>
  <div id="comparables-placeholder"></div>
{% endblock %}

{% block extra_js %}
  <script>
    window.appealFetchComparables = function () {
      const button = document.getElementById("comparables-button");
      const placeholder = document.getElementById("comparables-placeholder");
      const status = document.getElementById("comparables-status");
      if (!button || button.dataset.loading === "running") {
        return;
      }
      button.dataset.loading = "running";
      button.disabled = true;
      status.innerHTML = `
        <svg viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" opacity="0.25" />
          <path d="M22 12a10 10 0 00-10-10" stroke="currentColor" stroke-width="3" stroke-linecap="round" />
        </svg>
        Gathering comparable sales...
      `;
      fetch(button.dataset.url, { headers: { "X-Requested-With": "XMLHttpRequest" } })
        .then((response) => {
          if (!response.ok) {
            throw new Error("Unable to fetch");
          }
          return response.text();
        })
        .then((text) => {
          placeholder.innerHTML = text;
          status.textContent = "Comparables ready";
          button.textContent = "Comparables loaded";
        })
        .catch(() => {
          status.textContent = "Comparables unavailable. Try again.";
          button.disabled = false;
          button.dataset.loading = "";
        });
    };

    document.addEventListener("DOMContentLoaded", () => {
      window.appealFetchComparables();
    });
  </script>
{% endblock %}
