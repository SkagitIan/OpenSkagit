{% extends "openskagit/appeal_base_v3.html" %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 py-8 space-y-6">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
    <div>
      <h1 class="text-2xl font-semibold text-[#1f3327]">Regression Experiments</h1>
      <p class="text-sm text-gray-600">Launch and compare experiment-mode runs without touching production coefficients.</p>
    </div>
    <a href="{% url 'experiment_create' %}" class="inline-flex items-center px-4 py-2 rounded-lg bg-[#6B9080] text-white font-semibold hover:bg-[#5a7a6b] transition">
      <i class="fa-solid fa-flask mr-2"></i> New Experiment
    </a>
  </div>

  <form method="get" class="bg-white border border-[#dbe7dd] rounded-xl p-4 shadow-sm space-y-3">
    <div class="flex flex-wrap items-center gap-3">
      <div class="flex gap-2 text-sm">
        <button type="submit" name="status" value="" class="px-3 py-1 rounded-full border {% if not status_filter %}bg-[#6B9080] text-white border-[#6B9080]{% else %}bg-white text-gray-700 border-gray-300{% endif %}">
          All ({{ status_counts.all }})
        </button>
        <button type="submit" name="status" value="completed" class="px-3 py-1 rounded-full border {% if status_filter == 'completed' %}bg-[#6B9080] text-white border-[#6B9080]{% else %}bg-white text-gray-700 border-gray-300{% endif %}">
          Completed ({{ status_counts.completed }})
        </button>
        <button type="submit" name="status" value="running" class="px-3 py-1 rounded-full border {% if status_filter == 'running' %}bg-[#6B9080] text-white border-[#6B9080]{% else %}bg-white text-gray-700 border-gray-300{% endif %}">
          Running ({{ status_counts.running }})
        </button>
        <button type="submit" name="status" value="failed" class="px-3 py-1 rounded-full border {% if status_filter == 'failed' %}bg-[#6B9080] text-white border-[#6B9080]{% else %}bg-white text-gray-700 border-gray-300{% endif %}">
          Failed ({{ status_counts.failed }})
        </button>
      </div>
      <label class="inline-flex items-center gap-2 text-sm">
        <input type="checkbox" name="starred" value="true" {% if starred_filter == "true" %}checked{% endif %} class="rounded border-gray-300 text-[#6B9080] focus:ring-[#6B9080]">
        Starred only
      </label>
      <div class="flex items-center gap-2">
        <input type="text" name="search" value="{{ search }}" placeholder="Search name…" class="border border-gray-300 px-3 py-2 rounded-lg w-64 focus:ring-2 focus:ring-[#6B9080] focus:border-[#6B9080]">
        <button type="submit" class="px-3 py-2 rounded-lg border border-gray-300 text-sm hover:bg-gray-50">Apply</button>
      </div>
    </div>
  </form>

  <div class="space-y-3">
    {% for exp in experiments %}
    <div class="bg-white border border-[#dbe7dd] rounded-xl p-4 shadow-sm flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div class="space-y-1">
        <div class="flex items-center gap-2">
          <a href="{{ exp.get_absolute_url }}" class="font-semibold text-[#1f3327] hover:text-[#6B9080]">{{ exp.name }}</a>
          <span class="text-xs px-2 py-1 rounded-full border
            {% if exp.status == 'completed' %}border-emerald-200 bg-emerald-50 text-emerald-800
            {% elif exp.status == 'running' %}border-blue-200 bg-blue-50 text-blue-800
            {% elif exp.status == 'failed' %}border-red-200 bg-red-50 text-red-800
            {% else %}border-gray-200 bg-gray-50 text-gray-700{% endif %}">
            {{ exp.get_status_display }}
          </span>
          {% if exp.starred %}<span class="text-amber-500" title="Starred">★</span>{% endif %}
        </div>
        <div class="text-sm text-gray-600">
          {{ exp.predictor_profile }} · {{ exp.interaction_bundle }} · {{ exp.mode }} · {{ exp.created_at|date:"M j, Y g:i a" }}
        </div>
      </div>
      <div class="text-sm text-gray-800 grid grid-cols-2 gap-x-4 gap-y-1 text-right">
        <div>
          <div class="text-gray-500">COD</div>
          <div class="font-semibold">{% if exp.status == "completed" %}{{ exp.global_cod|default:"—" }}{% else %}—{% endif %}</div>
        </div>
        <div>
          <div class="text-gray-500">R²</div>
          <div class="font-semibold">{% if exp.status == "completed" %}{{ exp.global_r2|default:"—" }}{% else %}—{% endif %}</div>
        </div>
        <div>
          <div class="text-gray-500">Obs</div>
          <div class="font-semibold">{% if exp.status == "completed" %}{{ exp.total_observations|default:"—" }}{% else %}—{% endif %}</div>
        </div>
        <div>
          <div class="text-gray-500">Segments</div>
          <div class="font-semibold">{% if exp.status == "completed" %}{{ exp.segment_count|default:"—" }}{% else %}—{% endif %}</div>
        </div>
      </div>
    </div>
    {% empty %}
    <div class="text-gray-500 text-sm">No experiments yet.</div>
    {% endfor %}
  </div>

  <div class="bg-white border border-[#dbe7dd] rounded-xl p-4 shadow-sm">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-lg font-semibold text-[#1f3327]">Quick compare</h2>
      <a href="{% url 'experiment_compare' %}" class="text-sm text-[#6B9080] hover:underline">Open full compare</a>
    </div>
    <form method="get" action="{% url 'experiment_compare' %}" class="grid grid-cols-1 md:grid-cols-2 gap-3">
      <select name="exp1" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-[#6B9080] focus:border-[#6B9080]">
        <option value="">Select experiment A…</option>
        {% for c in compare_candidates %}
        <option value="{{ c.id }}">{{ c.name }} ({{ c.status }})</option>
        {% endfor %}
      </select>
      <select name="exp2" class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-[#6B9080] focus:border-[#6B9080]">
        <option value="">Select experiment B…</option>
        {% for c in compare_candidates %}
        <option value="{{ c.id }}">{{ c.name }} ({{ c.status }})</option>
        {% endfor %}
      </select>
      <div class="md:col-span-2 flex justify-end">
        <button type="submit" class="inline-flex items-center px-4 py-2 rounded-lg bg-[#6B9080] text-white font-semibold hover:bg-[#5a7a6b] transition">
          <i class="fa-solid fa-code-compare mr-2"></i> Compare
        </button>
      </div>
    </form>
  </div>
</div>
{% endblock %}
