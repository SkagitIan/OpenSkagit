{% extends "openskagit/appeal_base.html" %}

{% block page_title %}Step 1 â€” Address Entry{% endblock %}
{% block header_teaser %}
Simple, guided entry with a warm tone. Enter your address or parcel and weâ€™ll guide the rest.
{% endblock %}

{% block content %}
  <section class="card">
    <div class="step-header">
      <span class="icon">ğŸ“</span>
      Step 1 â€” Address Entry
    </div>
    <div class="search-column" style="margin-top: 16px;">
      <input id="appeal-search"
             name="q"
             type="text"
             placeholder="e.g., 101 Main St or P12345"
             hx-get="{% url 'appeal-parcel-search' %}"
             hx-target="#appeal-results"
             hx-trigger="keyup changed delay:500ms"
             hx-indicator="#appeal-search-indicator"
             hx-on::beforeRequest="const minLen=parseInt(this.dataset.minLength,10);if(this.value.trim().length<minLen){event.detail.shouldCancel=true;}"
             hx-on::keyup="
                const minLen=parseInt(this.dataset.minLength,10);
                const target=document.getElementById('appeal-results');
                if(this.value.trim().length<minLen){
                    target.innerHTML=`<p style=&quot;color:#475569;font-size:0.95rem;&quot;>Enter at least ${minLen} characters to searchâ€¦</p>`;
                }
             "
             data-min-length="3"
             autocomplete="off">
    <button class="address-button" type="button">Continue to Assessment Review â†’</button>
      <div class="indicator" id="appeal-search-indicator" style="display:none;">
        <svg viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" opacity="0.25" />
          <path d="M22 12a10 10 0 00-10-10" stroke="currentColor" stroke-width="3" stroke-linecap="round" />
        </svg>
        Searching propertiesâ€¦
      </div>
    </div>
    <div id="appeal-selection-display" class="selection-display hidden"></div>
    <div id="appeal-results" class="search-results"></div>
  </section>
{% endblock %}

{% block extra_js %}
  <script>
    window.appealSearchSelect = function (event) {
      const input = document.getElementById("appeal-search");
      const display = document.getElementById("appeal-selection-display");
      const results = document.getElementById("appeal-results");
      const button = event?.detail?.elt;
      if (!input || !display || !results || !button) {
        return;
      }
      const address = button.dataset.address || "";
      const parcel = button.dataset.parcel || "";
      const details = button.dataset.details || "";
      input.classList.add("hidden");
      display.innerHTML = `
        <div class="home-card">
          <div class="home-card-info">
            <p class="home-card-title">This is your home!</p>
            <p class="home-card-address">${address}</p>
            <p class="home-card-parcel">Parcel ${parcel}</p>
            ${details ? `<p class="home-card-details">${details}</p>` : ""}
          </div>
          <button class="home-card-change" type="button" onclick="window.appealSearchReset()">Change</button>
        </div>`;
      display.classList.remove("hidden");
      results.innerHTML = "";
      input.blur();
    };

    window.appealSearchReset = function () {
      const input = document.getElementById("appeal-search");
      const display = document.getElementById("appeal-selection-display");
      const results = document.getElementById("appeal-results");
      if (!input || !display || !results) {
        return;
      }
      display.classList.add("hidden");
      display.textContent = "";
    input.classList.remove("hidden");
    input.value = "";
    results.innerHTML = "";
    window.setTimeout(() => input.focus(), 0);
    };
    document.getElementById("appeal-search")?.focus();
  </script>
{% endblock %}
