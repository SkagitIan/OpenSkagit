{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Skagit Appeal Helper</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
</head>
<body class="bg-white text-slate-900">
  <main class="max-w-3xl mx-auto px-4 py-10 space-y-8">
    <header class="space-y-2">
      <h1 class="text-3xl font-bold tracking-tight">Property Tax Appeal Helper</h1>
      <p class="text-lg text-slate-600">Simple check to see if an appeal is worth your time. No jargon.</p>
    </header>

    <section class="rounded-2xl border border-slate-200 bg-slate-50 p-5">
      <label for="appeal-search" class="block text-sm font-semibold text-slate-700">Step 1 — Enter your address or parcel</label>
      <div class="mt-2 space-y-3">
        <input id="appeal-search"
               name="q"
               type="text"
               placeholder="e.g., 101 Main St or P12345"
               class="w-full rounded-xl border border-slate-300 bg-white px-4 py-3 text-lg placeholder:text-slate-400 focus:border-slate-500 focus:outline-none"
               hx-get="{% url 'appeal-parcel-search' %}"
               hx-target="#appeal-results"
               hx-trigger="keyup changed delay:500ms"
               hx-indicator="#appeal-search-indicator"
               hx-on::beforeRequest="const minLen=parseInt(this.dataset.minLength,10);if(this.value.trim().length<minLen){event.detail.shouldCancel=true;}"
               hx-on::keyup="
                  const minLen=parseInt(this.dataset.minLength,10);
                  const target=document.getElementById('appeal-results');
                  if(this.value.trim().length<minLen){
                      target.innerHTML=`<div class=&quot;text-sm text-slate-500&quot;>Enter at least ${minLen} characters to search…</div>`;
                  }
               "
               data-min-length="3"
               autocomplete="off">
        <div id="appeal-search-indicator" class="flex items-center gap-2 text-sm text-slate-500 htmx-indicator" style="display: none;">
          <svg class="h-4 w-4 animate-spin text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" aria-hidden="true">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
          </svg>
          <span>Searching properties…</span>
        </div>
        <div id="appeal-selection-display" class="hidden rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-600"></div>
      </div>
      <div id="appeal-results" class="mt-3"></div>
    </section>

    <section class="space-y-3">
      <div id="appeal-detail-indicator" class="flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-600 shadow-sm htmx-indicator" style="display: none;">
        <svg class="h-4 w-4 animate-spin text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" aria-hidden="true">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
        </svg>
        <span>Loading your appeal snapshot…</span>
      </div>
      <section id="appeal-detail" class="space-y-6"></section>
    </section>

    <footer class="text-sm text-slate-500">
      <p>Tip: An increasing assessment alone does not mean higher taxes. What matters is whether you rose more than similar homes nearby.</p>
    </footer>
  </main>
  <script>
    window.appealSearchSelect = function (event) {
      const input = document.getElementById("appeal-search");
      const display = document.getElementById("appeal-selection-display");
      const results = document.getElementById("appeal-results");
      const button = event?.detail?.elt;
      if (!input || !display || !results || !button) {
        return;
      }
      const address = button.dataset.address || "";
      const parcel = button.dataset.parcel || "";
      const details = button.dataset.details || "";
      input.classList.add("hidden");
      display.innerHTML = `
        <div class="flex items-start justify-between gap-4">
          <div>
            <p class="text-base font-semibold text-slate-900">${address}</p>
            <p class="text-xs text-slate-500">Parcel ${parcel}</p>
            ${details ? `<p class="text-xs text-slate-500 mt-1">${details}</p>` : ""}
          </div>
          <button type="button"
                  class="text-xs font-semibold text-slate-600 hover:text-slate-800"
                  onclick="window.appealSearchReset()">Change</button>
        </div>`;
      display.classList.remove("hidden");
      results.innerHTML = "";
      input.blur();
    };

    window.appealSearchReset = function () {
      const input = document.getElementById("appeal-search");
      const display = document.getElementById("appeal-selection-display");
      const results = document.getElementById("appeal-results");
      const detail = document.getElementById("appeal-detail");
      if (!input || !display || !results) {
        return;
      }
      display.classList.add("hidden");
      display.textContent = "";
      input.classList.remove("hidden");
      input.value = "";
      results.innerHTML = `<div class="text-sm text-slate-500">Start typing to find your home…</div>`;
      if (detail) {
        detail.innerHTML = "";
      }
      window.setTimeout(() => input.focus(), 0);
    };
  </script>
</body>
</html>
