{% load humanize formatting %}
<style>
  .comparables-section {
    animation: fadeInUp 0.6s var(--transition-base);
    margin-top: var(--space-8);
  }

  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-6);
    flex-wrap: wrap;
    gap: var(--space-4);
  }

  .section-title {
    display: flex;
    align-items: center;
    gap: var(--space-3);
  }

  .section-title__icon {
    width: 2.5rem;
    height: 2.5rem;
    border-radius: var(--radius-lg);
    background: linear-gradient(135deg, var(--dusty-grape), var(--dusty-taupe));
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: var(--shadow-md);
  }

  .section-title__text h3 {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--gray-900);
    margin: 0;
  }

  .section-title__text p {
    font-size: 0.875rem;
    color: var(--gray-600);
    margin: var(--space-1) 0 0;
  }

  .section-controls {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-4);
    align-items: flex-start;
    justify-content: flex-end;
  }

  /* View Switcher */
  .view-switcher {
    display: inline-flex;
    gap: var(--space-1);
    background: var(--gray-100);
    padding: var(--space-1);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
  }

  .view-btn {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-4);
    border: none;
    background: transparent;
    color: var(--gray-600);
    font-weight: 600;
    font-size: 0.875rem;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
    font-family: inherit;
  }

  .view-btn svg {
    width: 1rem;
    height: 1rem;
  }

  .view-btn--active {
    background: linear-gradient(135deg, var(--dusty-grape), var(--dusty-taupe));
    color: #fff;
    box-shadow: var(--shadow-sm);
  }

  .view-btn:hover:not(.view-btn--active) {
    color: var(--primary-500);
    background: rgba(255, 255, 255, 0.5);
  }

  /* Mode Switcher */
  .mode-switcher {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
    align-items: flex-start;
  }

  .mode-toggle {
    display: inline-flex;
    gap: var(--space-1);
    background: var(--gray-100);
    padding: var(--space-1);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
  }

  .mode-btn {
    border: none;
    background: transparent;
    padding: var(--space-2) var(--space-4);
    font-size: 0.875rem;
    font-weight: 600;
    border-radius: var(--radius-md);
    color: var(--gray-600);
    cursor: pointer;
    transition: all var(--transition-fast);
    font-family: inherit;
  }

  .mode-btn:hover:not(.mode-btn--active) {
    color: var(--primary-500);
    background: rgba(255, 255, 255, 0.5);
  }

  .mode-btn--active {
    background: linear-gradient(135deg, var(--dusty-grape), var(--dusty-taupe));
    color: #fff;
    box-shadow: var(--shadow-sm);
  }

  .mode-note {
    font-size: 0.8125rem;
    color: var(--gray-600);
  }

  .mode-note--warning {
    color: var(--rose-600);
  }

  .comparables-more-btn {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-4);
    border: none;
    border-radius: var(--radius-full);
    background: linear-gradient(135deg, var(--dusty-grape), var(--dusty-taupe));
    color: #fff;
    font-weight: 600;
    cursor: pointer;
    font-family: inherit;
    transition: transform var(--transition-fast), box-shadow var(--transition-fast), opacity var(--transition-fast);
    box-shadow: var(--shadow-md);
  }

  .comparables-more-btn:disabled {
    opacity: 0.7;
    cursor: default;
    box-shadow: none;
  }

  .comparables-more-btn svg {
    width: 1rem;
    height: 1rem;
  }

  /* View Containers */
  .view-container {
    display: none;
  }

  .view-container--active {
    display: block;
  }

  /* List View */
  .comp-list {
    display: grid;
    gap: var(--space-4);
  }

  .comp-card {
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-2xl);
    overflow: hidden;
    box-shadow: var(--shadow-sm);
    transition: transform var(--transition-fast), box-shadow var(--transition-fast);
    animation: slideInRight 0.4s var(--transition-base);
    animation-fill-mode: both;
  }

  .comp-card:nth-child(1) { animation-delay: 0.05s; }
  .comp-card:nth-child(2) { animation-delay: 0.1s; }
  .comp-card:nth-child(3) { animation-delay: 0.15s; }
  .comp-card:nth-child(4) { animation-delay: 0.2s; }
  .comp-card:nth-child(5) { animation-delay: 0.25s; }
  .comp-card:nth-child(6) { animation-delay: 0.3s; }
  .comp-card:nth-child(7) { animation-delay: 0.35s; }

  .comp-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
  }

  .comp-card__header {
    padding: var(--space-5);
    background: var(--gray-50);
    border-bottom: 1px solid var(--gray-200);
  }

  .comp-card__header {
    display: flex;
    align-items: flex-start;
    gap: var(--space-3);
  }

  .comp-card__header-content {
    display: flex;
    justify-content: space-between;
    gap: var(--space-4);
    align-items: flex-start;
    flex: 1;
  }

  .comp-card__header-gauge {
    width: 100px;
  }

  .comp-card__title {
    font-size: 1.05rem;
    font-weight: 600;
    color: var(--gray-900);
    margin-bottom: var(--space-2);
  }

  .comp-card__meta {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    font-size: 0.85rem;
    color: var(--gray-600);
    flex-wrap: wrap;
  }

  .comp-card__meta.comp-card__meta--grid {
    justify-content: space-between;
    padding: var(--space-2) var(--space-5) 0;
    border-top: 1px solid var(--gray-100);
    margin-bottom: var(--space-2);
  }

  .comp-card__meta-item {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
  }

  .comp-card__meta-item svg {
    width: 0.9rem;
    height: 0.9rem;
    color: var(--gray-500);
  }

  .comp-price-block {
    text-align: right;
  }

  .comp-card__price {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--gray-900);
    line-height: 1.1;
  }

  .comp-card__price-label {
    font-size: 0.75rem;
    color: var(--gray-500);
    margin-top: 0.1rem;
  }

  .comp-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
    background: white;
    border-bottom: 1px solid var(--gray-200);
  }

  .comp-stat {
    padding: var(--space-4) var(--space-2);
    text-align: center;
    border-right: 1px solid var(--gray-100);
  }

  .comp-stat:last-child {
    border-right: none;
  }

  .comp-stat__value {
    font-size: 1.15rem;
    font-weight: 700;
    color: var(--gray-900);
  }

  .comp-stat__label {
    font-size: 0.7rem;
    color: var(--gray-600);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-top: var(--space-1);
  }

  .comp-card__adjustments {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-4);
    align-items: center;
    padding: var(--space-4) var(--space-5);
    background: var(--gray-50);
    border-bottom: 1px solid var(--gray-200);
    font-size: 0.85rem;
  }

  .adjustments-label {
    font-weight: 600;
    color: var(--gray-600);
  }

  .adjustments-badges {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-3);
    color: var(--gray-700);
  }

  .adjustment-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.35rem 0.85rem;
    border-radius: var(--radius-full);
    border: 1px solid transparent;
    background: var(--gray-100);
    font-size: 0.8rem;
    font-weight: 600;
  }

  .adjustment-badge__icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 1.2rem;
    height: 1.2rem;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.4);
  }

  .adjustment-badge__icon i {
    font-size: 0.85rem;
    color: inherit;
  }

  .adjustment-badge__amount {
    font-weight: 700;
  }

  .adjustment-badge--positive {
    background: var(--success-50);
    border-color: rgba(16, 185, 129, 0.4);
  }

  .adjustment-badge--positive {
    background: rgba(16, 185, 129, 0.15);
    color: var(--success-600);
  }

  .adjustment-badge--positive {
    color: var(--success-600);
  }

  .adjustment-badge--negative {
    background: var(--error-50);
    border-color: rgba(239, 68, 68, 0.35);
  }

  .adjustment-badge--negative {
    background: rgba(239, 68, 68, 0.15);
    color: var(--error-600);
  }

  .adjustment-badge--negative{
    color: var(--error-600);
  }

  .adjustment-entry {
    font-size: 0.85rem;
    color: var(--gray-600);
  }

  .adjustment-entry--muted {
    font-weight: 500;
  }

  .comp-card__adjustments--collapsible {
    flex-direction: column;
    gap: var(--space-3);
  }

  .comp-card__adjustments-summary {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-3);
    margin: 0;
    padding: 0;
    cursor: pointer;
  }

  .comp-card__adjustments-summary-row {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    flex-wrap: wrap;
    min-width: 0;
  }

  .adjustments-summary-text {
    color: var(--gray-700);
    font-size: 0.85rem;
    font-weight: 600;
    min-width: 0;
  }

  .comp-card__adjustments-summary-indicator {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 1.6rem;
    height: 1.6rem;
    border-radius: 999px;
    background: rgba(99, 102, 241, 0.15);
    transition: transform 0.25s ease;
  }

  .comp-card__adjustments-summary::-webkit-details-marker,
  .comp-card__adjustments-summary::marker {
    display: none;
  }

  .comp-card__adjustments--collapsible[open]
    .comp-card__adjustments-summary-indicator {
    transform: rotate(180deg);
  }

  .comp-card__adjustments-body {
    width: 100%;
    border-top: 1px solid var(--gray-200);
    padding-top: var(--space-3);
  }

  .comp-card__adjustments-body .adjustments-badges {
    margin-top: 0;
  }

  .comp-card__adjusted-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-4) var(--space-5);
    background: white;
  }

  .comp-adjusted__label {
    font-size: 0.65rem;
    font-weight: 600;
    color: var(--gray-500);
    letter-spacing: 0.08em;
  }

  .comp-adjusted__value {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--gray-900);
  }

  .comp-adjusted__delta {
    font-size: 0.85rem;
    font-weight: 600;
    margin-left: var(--space-2);
  }

  .comp-adjusted__delta--up {
    color: var(--success-600);
  }

  .comp-adjusted__delta--down {
    color: var(--rose-600);
  }

  .comp-adjusted__missing {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--rose-600);
  }

  .comp-similarity {
    position: relative;
    width: 100%;
  }

  .comp-similarity__trigger {
    border: none;
    background: transparent;
    padding: 0;
    display: block;
    cursor: pointer;
  }

  .comp-similarity__gauge {
    --value: 0%;
    width: 88px;
    height: 88px;
    border-radius: 50%;
    background-image: conic-gradient(
      var(--comp-similarity-color, #6c698d) 0 var(--value),
      var(--gray-200) var(--value) 100%
    );
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .comp-similarity__gauge::after {
    content: "";
    position: absolute;
    inset: 14px;
    border-radius: 50%;
    background: white;
    box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.03);
    z-index: 1;
  }

  .comp-similarity__gauge-inner {
    position: relative;
    z-index: 2;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.15rem;
  }

  .comp-similarity__value {
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--gray-900);
  }

  .comp-similarity__tooltip {
    position: absolute;
    top: calc(100% + var(--space-2));
    left: 0;
    z-index: 2;
    background: white;
    border-radius: var(--radius-lg);
    border: 1px solid rgba(39, 39, 42, 0.1);
    padding: var(--space-3) var(--space-4);
    box-shadow: var(--shadow-lg);
    min-width: 220px;
    display: none;
  }

  .comp-similarity.is-open .comp-similarity__tooltip {
    display: block;
  }

  .comp-similarity__tooltip table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--gray-600);
  }

  .comp-similarity__tooltip th {
    text-align: left;
    padding-right: var(--space-2);
    font-weight: 600;
  }

  .comp-similarity__tooltip td {
    text-align: right;
    font-weight: 700;
    color: var(--gray-900);
  }

  /* Grid View */
  .comp-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: var(--space-4);
  }

  .comp-grid .comp-card {
    height: 100%;
  }

  /* Map View */
  #comparables-map {
    height: 600px;
    width: 100%;
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-lg);
    z-index: 1;
  }

  .map-container {
    position: relative;
  }

  .leaflet-popup-content-wrapper {
    border-radius: var(--radius-lg);
  }

  .popup-content {
    padding: var(--space-2);
    min-width: 200px;
  }

  .popup-content strong {
    display: block;
    font-size: 0.9375rem;
    margin-bottom: var(--space-2);
    color: var(--gray-900);
  }

  .popup-content div {
    font-size: 0.8125rem;
    color: var(--gray-600);
    margin-bottom: var(--space-1);
  }

  @keyframes slideInRight {
    from {
      opacity: 0;
      transform: translateX(-20px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  @media (max-width: 768px) {
    .view-switcher {
      width: 100%;
      justify-content: center;
    }
    .comp-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<div class="card comparables-section" id="appeal-comparables-root" data-fetch-url="{{ fetch_url }}" data-active-mode="{{ view_mode }}">
  <div class="section-header">
    <div class="section-title">
      <div class="section-title__icon">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
          <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
      </div>
      <div class="section-title__text">
        <h3>Comparable Sales</h3>
        <p>{{ comparables|length }} similar properties found nearby</p>
      </div>
    </div>

    <div class="section-controls">
      <div class="view-switcher">
        <button class="view-btn view-btn--active" data-view="list" onclick="switchView('list')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="8" y1="6" x2="21" y2="6"></line>
            <line x1="8" y1="12" x2="21" y2="12"></line>
            <line x1="8" y1="18" x2="21" y2="18"></line>
            <line x1="3" y1="6" x2="3.01" y2="6"></line>
            <line x1="3" y1="12" x2="3.01" y2="12"></line>
            <line x1="3" y1="18" x2="3.01" y2="18"></line>
          </svg>
          List
        </button>
        <button class="view-btn" data-view="grid" onclick="switchView('grid')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="7" height="7"></rect>
            <rect x="14" y="3" width="7" height="7"></rect>
            <rect x="14" y="14" width="7" height="7"></rect>
            <rect x="3" y="14" width="7" height="7"></rect>
          </svg>
          Grid
        </button>
        <button class="view-btn" data-view="map" onclick="switchView('map')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon>
            <line x1="8" y1="2" x2="8" y2="18"></line>
            <line x1="16" y1="6" x2="16" y2="22"></line>
          </svg>
          Map
        </button>
      </div>
      <div class="mode-switcher">
        <div class="mode-toggle">
          <button class="mode-btn {% if not advanced_mode %}mode-btn--active{% endif %}" type="button" onclick="handleComparablesMode('standard')">Standard</button>
          <button class="mode-btn {% if advanced_mode %}mode-btn--active{% endif %}" type="button" onclick="handleComparablesMode('advanced')">Advanced</button>
        </div>
        {% if advanced_error %}
          <p class="mode-note mode-note--warning">{{ advanced_error }}</p>
        {% endif %}
      </div>

    </div>
  </div>

  <!-- List View -->
  <div id="list-view" class="view-container view-container--active">
    <div class="comp-list">
      {% for comp in comparables %}
        <div class="comp-card">
          <div class="comp-card__header">
            <div class="comp-card__header-gauge">
              <div class="comp-similarity">
                <button class="comp-similarity__trigger" type="button" aria-expanded="false">
                  <div class="comp-similarity__gauge" style="--value: {{ comp.similarity.overall|default_if_none:0 }}%;">
                    <div class="comp-similarity__gauge-inner">
                      <span class="comp-similarity__value">
                        {% if comp.similarity.overall is not None %}
                          {{ comp.similarity.overall }}%
                        {% else %}
                          0%
                        {% endif %}
                      </span>
                    </div>
                  </div>
                </button>
              <div class="comp-similarity__tooltip" role="tooltip">
                <table>
                  <tr><th>Time</th><td>{% if comp.similarity.time is not None %}{{ comp.similarity.time }}%{% else %}&mdash;{% endif %}</td></tr>
                  <tr><th>Proximity</th><td>{% if comp.similarity.proximity is not None %}{{ comp.similarity.proximity }}%{% else %}&mdash;{% endif %}</td></tr>
                  <tr><th>Size</th><td>{% if comp.similarity.size is not None %}{{ comp.similarity.size }}%{% else %}&mdash;{% endif %}</td></tr>
                  <tr><th>Quality</th><td>{% if comp.similarity.quality_condition is not None %}{{ comp.similarity.quality_condition }}%{% else %}&mdash;{% endif %}</td></tr>
                  <tr><th>Land</th><td>{% if comp.similarity.land is not None %}{{ comp.similarity.land }}%{% else %}&mdash;{% endif %}</td></tr>
                </table>
              </div>
              </div>
            </div>
            <div class="comp-card__header-content">
              <div>
                <div class="comp-card__title">{{ comp.address|default:"Address unavailable" }}</div>
                <div class="comp-card__meta">
                  <span class="comp-card__meta-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M12 21s7-4.5 7-11A7 7 0 0 0 5 10c0 6.5 7 11 7 11z"></path>
                      <circle cx="12" cy="10" r="2.5"></circle>
                    </svg>
                    {{ comp.distance_miles|floatformat:2 }} mi
                  </span>
                  <span class="comp-card__meta-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                      <rect x="3" y="5" width="18" height="16" rx="2"></rect>
                      <line x1="16" y1="3" x2="16" y2="7"></line>
                      <line x1="8" y1="3" x2="8" y2="7"></line>
                      <line x1="3" y1="11" x2="21" y2="11"></line>
                    </svg>
                    Sold {{ comp.sale_date|date:"M Y" }}
                  </span>
                </div>
              </div>
              <div class="comp-price-block">
                <div class="comp-card__price">${{ comp.sale_price|floatformat:0|intcomma }}</div>
                <div class="comp-card__price-label">Sale Price</div>
              </div>
            </div>
          </div>

          <div class="comp-stats">
            <div class="comp-stat">
              <div class="comp-stat__value">{{ comp.bedrooms|default:"—"|floatformat:"-1" }}</div>
              <div class="comp-stat__label">Beds</div>
            </div>
            <div class="comp-stat">
              <div class="comp-stat__value">{{ comp.bathrooms|quarter_baths|default:"—" }}</div>
              <div class="comp-stat__label">Baths</div>
            </div>
            <div class="comp-stat">
              <div class="comp-stat__value">{{ comp.living_area|default:"—"|floatformat:0|intcomma }}</div>
              <div class="comp-stat__label">Sq Ft</div>
            </div>
            <div class="comp-stat">
              <div class="comp-stat__value">{{ comp.year_built|default:"—" }}</div>
              <div class="comp-stat__label">Built</div>
            </div>
            <div class="comp-stat">
              <div class="comp-stat__value">${{ comp.price_per_sqft|default:"—"|floatformat:0|intcomma }}</div>
              <div class="comp-stat__label">$/Sq Ft</div>
            </div>
          </div>

          {% if advanced_mode %}
            <div class="comp-card__adjustments">
              <span class="adjustments-label">Adjustments:</span>
              {% if comp.adjustments %}
                <div class="adjustments-badges">
                  {% for item in comp.adjustments %}
                    {% if item.amount %}
                      {% with item.label|default:""|lower as label_lower %}
                        <span class="adjustment-badge {% if item.amount > 0 %}adjustment-badge--positive{% else %}adjustment-badge--negative{% endif %}">
                          {% if 'living' in label_lower %}
                            <span class="adjustment-badge__icon">
                              <i class="fa-solid fa-house-chimney-user" aria-hidden="true"></i>
                            </span>
                          {% elif 'lot' in label_lower or 'land' in label_lower %}
                            <span class="adjustment-badge__icon">
                              <i class="fa-solid fa-map-pin" aria-hidden="true"></i>
                            </span>
                          {% elif 'trend' in label_lower or 'time' in label_lower %}
                            <span class="adjustment-badge__icon">
                              <i class="fa-solid fa-timeline" aria-hidden="true"></i>
                            </span>
                          {% elif 'age' in label_lower or 'year' in label_lower or 'built' in label_lower %}
                            <span class="adjustment-badge__icon">
                              <i class="fa-solid fa-calendar-days" aria-hidden="true"></i>
                            </span>
                          {% else %}
                            <span class="adjustment-badge__icon">
                              <i class="fa-solid fa-sliders" aria-hidden="true"></i>
                            </span>
                          {% endif %}
                          <span class="sr-only">{{ item.label }}</span>
                          <span class="adjustment-badge__amount">
                            {% if item.amount > 0 %}+{% elif item.amount < 0 %}-{% endif %}${{ item.amount|abs|floatformat:0|intcomma }}
                          </span>
                        </span>
                      {% endwith %}
                    {% endif %}
                  {% endfor %}
                </div>
              {% elif advanced_error %}
                <span class="adjustment-entry adjustment-entry--muted">{{ advanced_error }}</span>
              {% else %}
                <span class="adjustment-entry adjustment-entry--muted">Not available</span>
              {% endif %}
            </div>
            <div class="comp-card__adjusted-row">
              <span class="comp-adjusted__label">Adjusted Value</span>
              <div>
                {% if comp.adjusted_value %}
                  <span class="comp-adjusted__value">${{ comp.adjusted_value|floatformat:0|intcomma }}</span>
                  {% if comp.total_adjustment %}
                    {% if comp.total_adjustment > 0 %}
                      <span class="comp-adjusted__delta comp-adjusted__delta--up">+${{ comp.total_adjustment|floatformat:0|intcomma }}</span>
                    {% elif comp.total_adjustment < 0 %}
                      <span class="comp-adjusted__delta comp-adjusted__delta--down">-${{ comp.total_adjustment|abs|floatformat:0|intcomma }}</span>
                    {% endif %}
                  {% endif %}
                {% elif advanced_error %}
                  <span class="comp-adjusted__missing">Unavailable</span>
                {% else %}
                  <span class="comp-adjusted__missing">Not calculated</span>
                {% endif %}
              </div>
            </div>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  </div>

  <!-- Grid View -->
  <div id="grid-view" class="view-container">
    <div class="comp-grid">
      {% for comp in comparables %}

        <div class="comp-card">
          <div class="comp-card__header">
            <div class="comp-card__header-gauge">
              <div class="comp-similarity">
                <button class="comp-similarity__trigger" type="button" aria-expanded="false">
                  <div class="comp-similarity__gauge" style="--value: {{ comp.similarity.overall|default_if_none:0 }}%;">
                    <div class="comp-similarity__gauge-inner">
                      <span class="comp-similarity__value">
                        {% if comp.similarity.overall is not None %}
                          {{ comp.similarity.overall }}%
                        {% else %}
                          0%
                        {% endif %}
                      </span>
                    </div>
                  </div>
                </button>
              </div>
            </div>
            <div class="comp-card__header-content">
              <div>
                <div class="comp-card__title">{{ comp.address|default:"Address unavailable" }}</div>
              </div>
              <div class="comp-price-block">
                <div class="comp-card__price">${{ comp.sale_price|floatformat:0|intcomma }}</div>
                <div class="comp-card__price-label">Sale Price</div>
              </div>
            </div>
          </div>

          <div class="comp-card__meta comp-card__meta--grid">
            <span class="comp-card__meta-item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 21s7-4.5 7-11A7 7 0 0 0 5 10c0 6.5 7 11 7 11z"></path>
                <circle cx="12" cy="10" r="2.5"></circle>
              </svg>
              {{ comp.distance_miles|floatformat:2 }} mi
            </span>
            <span class="comp-card__meta-item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="5" width="18" height="16" rx="2"></rect>
                <line x1="16" y1="3" x2="16" y2="7"></line>
                <line x1="8" y1="3" x2="8" y2="7"></line>
                <line x1="3" y1="11" x2="21" y2="11"></line>
              </svg>
              Sold {{ comp.sale_date|date:"M Y" }}
            </span>
          </div>

          <div class="comp-stats">
            <div class="comp-stat">
              <div class="comp-stat__value">{{ comp.bedrooms|default:"—"|floatformat:"-1" }}</div>
              <div class="comp-stat__label">Beds</div>
            </div>
            <div class="comp-stat">
              <div class="comp-stat__value">{{ comp.bathrooms|quarter_baths|default:"—" }}</div>
              <div class="comp-stat__label">Baths</div>
            </div>
            <div class="comp-stat">
              <div class="comp-stat__value">{{ comp.living_area|default:"—"|floatformat:0|intcomma }}</div>
              <div class="comp-stat__label">Sq Ft</div>
            </div>
            <div class="comp-stat">
              <div class="comp-stat__value">{{ comp.year_built|default:"—" }}</div>
              <div class="comp-stat__label">Built</div>
            </div>
            <div class="comp-stat">
              <div class="comp-stat__value">${{ comp.price_per_sqft|default:"—"|floatformat:0|intcomma }}</div>
              <div class="comp-stat__label">$/Sq Ft</div>
            </div>
          </div>
          {% if advanced_mode %}
            {% if comp.adjustments %}
              <details class="comp-card__adjustments comp-card__adjustments--collapsible">
                <summary class="comp-card__adjustments-summary">
                  <div class="comp-card__adjustments-summary-row">
                    <span class="adjustments-label">Adjustments:</span>
                    <span class="adjustments-summary-text">
                      {% if comp.adjustments_excerpt %}
                        {{ comp.adjustments_excerpt|join:" | " }}
                      {% else %}
                        No adjustments applied
                      {% endif %}
                    </span>
                  </div>
                  <span class="comp-card__adjustments-summary-indicator" aria-hidden="true">
                    <i class="fa-solid fa-chevron-down"></i>
                  </span>
                </summary>
                <div class="comp-card__adjustments-body">
                  <div class="adjustments-badges">
                    {% for item in comp.adjustments %}
                      {% if item.amount %}
                        {% with item.label|default:""|lower as label_lower %}
                          <span class="adjustment-badge {% if item.amount > 0 %}adjustment-badge--positive{% else %}adjustment-badge--negative{% endif %}">
                            {% if 'living' in label_lower %}
                              <span class="adjustment-badge__icon">
                                <i class="fa-solid fa-house-chimney-user" aria-hidden="true"></i>
                              </span>
                            {% elif 'lot' in label_lower or 'land' in label_lower %}
                              <span class="adjustment-badge__icon">
                                <i class="fa-solid fa-map-pin" aria-hidden="true"></i>
                              </span>
                            {% elif 'trend' in label_lower or 'time' in label_lower %}
                              <span class="adjustment-badge__icon">
                                <i class="fa-solid fa-timeline" aria-hidden="true"></i>
                              </span>
                            {% elif 'age' in label_lower or 'year' in label_lower or 'built' in label_lower %}
                              <span class="adjustment-badge__icon">
                                <i class="fa-solid fa-calendar-days" aria-hidden="true"></i>
                              </span>
                            {% else %}
                              <span class="adjustment-badge__icon">
                                <i class="fa-solid fa-sliders" aria-hidden="true"></i>
                              </span>
                            {% endif %}
                            <span class="sr-only">{{ item.label }}</span>
                            <span class="adjustment-badge__amount">
                              {% if item.amount > 0 %}+{% elif item.amount < 0 %}-{% endif %}${{ item.amount|abs|floatformat:0|intcomma }}
                            </span>
                          </span>
                        {% endwith %}
                      {% endif %}
                    {% endfor %}
                  </div>
                </div>
              </details>
            {% elif advanced_error %}
              <span class="adjustment-entry adjustment-entry--muted">{{ advanced_error }}</span>
            {% else %}
              <span class="adjustment-entry adjustment-entry--muted">Not available</span>
            {% endif %}
            <div class="comp-card__adjusted-row">
              <span class="comp-adjusted__label">Adjusted Value</span>
              <div>
                {% if comp.adjusted_value %}
                  <span class="comp-adjusted__value">${{ comp.adjusted_value|floatformat:0|intcomma }}</span>
                  {% if comp.total_adjustment %}
                    {% if comp.total_adjustment > 0 %}
                      <span class="comp-adjusted__delta comp-adjusted__delta--up">+${{ comp.total_adjustment|floatformat:0|intcomma }}</span>
                    {% elif comp.total_adjustment < 0 %}
                      <span class="comp-adjusted__delta comp-adjusted__delta--down">-${{ comp.total_adjustment|abs|floatformat:0|intcomma }}</span>
                    {% endif %}
                  {% endif %}
                {% elif advanced_error %}
                  <span class="comp-adjusted__missing">Unavailable</span>
                {% else %}
                  <span class="comp-adjusted__missing">Not calculated</span>
                {% endif %}
              </div>
            </div>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  </div>

  <!-- Map View -->
  <div id="map-view" class="view-container">
    <div class="map-container">
      <div id="comparables-map"></div>
    </div>
  </div>
</div>
      {% if has_more %}
        <button
          id="comparables-more-button"
          class="comparables-more-btn"
          type="button"
          data-extended-count="{{ extended_limit }}"
        >
          <span class="comparables-more-label">Get more comps</span>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 5v14"></path>
            <path d="M5 12h14"></path>
          </svg>
        </button>
      {% endif %}
<script>
  let comparablesMap = null;
  let markersGroup = null;

  function handleComparablesMode(mode) {
    const root = document.getElementById('appeal-comparables-root');
    if (root && root.dataset.activeMode === mode) {
      return;
    }
    if (root) {
      root.dataset.activeMode = mode;
    }
    if (window.appealUpdateComparables) {
      window.appealUpdateComparables(mode);
    } else if (root && root.dataset.fetchUrl) {
      const params = mode ? `?view_mode=${encodeURIComponent(mode)}` : "";
      window.location.href = `${root.dataset.fetchUrl}${params}`;
    }
  }

  function switchView(view) {
    // Update buttons
    document.querySelectorAll('.view-btn').forEach(btn => {
      btn.classList.toggle('view-btn--active', btn.dataset.view === view);
    });

    // Show/hide views
    document.querySelectorAll('.view-container').forEach(container => {
      container.classList.remove('view-container--active');
    });

    const targetView = document.getElementById(view + '-view');
    if (targetView) {
      targetView.classList.add('view-container--active');
    }

    // Initialize map if needed
    if (view === 'map' && !comparablesMap) {
      setTimeout(initComparablesMap, 100);
    } else if (view === 'map' && comparablesMap) {
      setTimeout(() => comparablesMap.invalidateSize(), 100);
    }
  }

  function initComparablesMap() {
    const mapEl = document.getElementById('comparables-map');
    if (!mapEl || comparablesMap) return;

    // Initialize map
    comparablesMap = L.map('comparables-map').setView([48.5, -122.5], 11);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap contributors'
    }).addTo(comparablesMap);

    markersGroup = L.featureGroup().addTo(comparablesMap);

    // Add subject property marker (red)
    {% if subject.latitude and subject.longitude %}
      const subjectMarker = L.marker([{{ subject.latitude }}, {{ subject.longitude }}], {
        icon: L.divIcon({
          className: 'subject-marker',
          html: '<div style="background: #ef4444; width: 14px; height: 14px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
          iconSize: [20, 20],
          iconAnchor: [10, 10]
        })
      }).addTo(markersGroup);

      subjectMarker.bindPopup('<div class="popup-content"><strong>Your Property</strong><div>{{ subject.address|default:"" }}</div></div>');
    {% endif %}

    // Add comparable markers (dusty grape color)
    const comparables = [
      {% for comp in comparables %}
        {% if comp.latitude and comp.longitude %}
          {
            lat: {{ comp.latitude }},
            lon: {{ comp.longitude }},
            address: "{{ comp.address|default:""|escapejs }}",
            price: "{{ comp.sale_price|floatformat:0|intcomma }}",
            date: "{{ comp.sale_date|date:"M j, Y" }}",
            distance: "{{ comp.distance_miles|floatformat:2 }}",
            beds: "{{ comp.bedrooms|default:"—"|floatformat:"-1" }}",
            baths: "{{ comp.bathrooms|quarter_baths|default:"—" }}",
            sqft: "{{ comp.living_area|default:"—"|floatformat:0|intcomma }}",
            adjusted_value: {{ comp.adjusted_value|default:"null" }},
            total_adjustment: {{ comp.total_adjustment|default:"null" }}
          },
        {% endif %}
      {% endfor %}
    ];

    comparables.forEach((comp, index) => {
      const marker = L.marker([comp.lat, comp.lon], {
        icon: L.divIcon({
          className: 'comp-marker',
          html: '<div style="background: #6c698d; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.2);"></div>',
          iconSize: [16, 16],
          iconAnchor: [8, 8]
        })
      }).addTo(markersGroup);

      marker.bindPopup(`
        <div class="popup-content">
          <strong>${comp.address}</strong>
          <div>Sale: $${comp.price}</div>
          <div>Date: ${comp.date}</div>
          <div>Distance: ${comp.distance} mi</div>
          <div>${comp.beds} beds, ${comp.baths} baths</div>
          <div>${comp.sqft} sq ft</div>
          {% if advanced_mode %}
            ${comp.adjusted_value !== null ? `<div>Adjusted: $${comp.adjusted_value.toLocaleString()}${comp.total_adjustment !== null && comp.total_adjustment !== 0 ? ` (${comp.total_adjustment > 0 ? '+' : ''}$${Math.abs(comp.total_adjustment).toLocaleString()})` : ''}</div>` : ''}
          {% endif %}
        </div>
      `);
    });

    // Fit bounds to show all markers
    if (markersGroup.getBounds().isValid()) {
      comparablesMap.fitBounds(markersGroup.getBounds(), { padding: [50, 50] });
    }

    setTimeout(() => comparablesMap.invalidateSize(), 100);
  }

  // Auto-initialize animations
  document.addEventListener('DOMContentLoaded', () => {
    if (typeof anime !== 'undefined') {
      anime({
        targets: '.comp-card',
        translateX: [20, 0],
        opacity: [0, 1],
        delay: anime.stagger(100),
        duration: 400,
        easing: 'easeOutQuad'
      });
    }

    const similarityContainers = Array.from(document.querySelectorAll('.comp-similarity'));
    const similarityTriggers = document.querySelectorAll('.comp-similarity__trigger');

    const closeAllSimilarity = () => {
      similarityContainers.forEach((container) => {
        container.classList.remove('is-open');
        const trigger = container.querySelector('.comp-similarity__trigger');
        if (trigger) {
          trigger.setAttribute('aria-expanded', 'false');
        }
      });
    };

    similarityTriggers.forEach((trigger) => {
      trigger.addEventListener('click', (event) => {
        event.preventDefault();
        event.stopPropagation();
        const container = trigger.closest('.comp-similarity');
        if (!container) {
          return;
        }
        const currentlyOpen = container.classList.contains('is-open');
        closeAllSimilarity();
        if (!currentlyOpen) {
          container.classList.add('is-open');
          trigger.setAttribute('aria-expanded', 'true');
        }
      });
    });

    similarityContainers.forEach((container) => {
      const tooltip = container.querySelector('.comp-similarity__tooltip');
      if (tooltip) {
        tooltip.addEventListener('click', (event) => {
          event.stopPropagation();
        });
      }
    });

    document.addEventListener('click', () => closeAllSimilarity());
    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        closeAllSimilarity();
      }
    });
  });
</script>

<style>
  .fairness-trigger-card {
    margin-top: var(--space-8);
    padding: var(--space-5);
    border-radius: var(--radius-2xl);
    border: 1px dashed var(--gray-300);
    background: radial-gradient(circle at top left, #eef2ff, #f9fafb);
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }

  .fairness-trigger-header {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-3);
    justify-content: space-between;
    align-items: center;
  }

  .fairness-trigger-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--gray-900);
  }

  .fairness-trigger-subtitle {
    font-size: 0.9rem;
    color: var(--gray-600);
    max-width: 36rem;
  }

  .fairness-trigger-actions {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
    align-items: center;
  }

  .fairness-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.55rem 1.1rem;
    border-radius: 999px;
    border: none;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    background: linear-gradient(135deg, var(--dusty-grape), var(--dusty-taupe));
    color: #fff;
    box-shadow: var(--shadow-md);
    transition: transform var(--transition-fast), box-shadow var(--transition-fast), opacity var(--transition-fast);
  }

  .fairness-btn[disabled] {
    opacity: 0.7;
    cursor: default;
    box-shadow: none;
  }

  .fairness-btn:not([disabled]):hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow-lg);
  }

  .fairness-spinner {
    width: 0.85rem;
    height: 0.85rem;
    border-radius: 999px;
    border: 2px solid rgba(255,255,255,0.5);
    border-top-color: #fff;
    animation: fairness-spin 0.6s linear infinite;
  }

  @keyframes fairness-spin {
    to { transform: rotate(360deg); }
  }

  .fairness-trigger-note {
    font-size: 0.8rem;
    color: var(--gray-600);
  }
</style>

<div class="fairness-trigger-card">
  <div class="fairness-trigger-header">
    <div>
      <div class="fairness-trigger-title">Run Fairness Analysis</div>
      <p class="fairness-trigger-subtitle">
        Bring together your subject, neighborhood metrics, and comparable sales into a single IAAO-style fairness
        checklist. This can help you decide whether an appeal feels reasonable.
      </p>
    </div>
    <div class="fairness-trigger-actions">
      <button
        id="fairness-analysis-button"
        class="fairness-btn"
        type="button"
        data-url="{% url 'appeal-result-fairness' parcel_number %}"
      >
        <span>Run Fairness Analysis</span>
        <svg style="width: 1rem; height: 1rem;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="9 11 12 14 22 4"></polyline>
          <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
        </svg>
      </button>
      <div class="fairness-trigger-note">
        Uses anonymous neighborhood statistics and a model tuned to IAAO fairness concepts. No legal advice.
      </div>
    </div>
  </div>
  <div id="fairness-analysis-result"></div>
</div>

<script>
  (function () {
    const button = document.getElementById('fairness-analysis-button');
    const resultContainer = document.getElementById('fairness-analysis-result');

    if (!button || !resultContainer) {
      return;
    }

    function setLoading(isLoading) {
      if (isLoading) {
        button.disabled = true;
        button.innerHTML = '<div class="fairness-spinner"></div><span>Running analysis…</span>';
      } else {
        button.disabled = false;
        button.innerHTML = '<span>Run Fairness Analysis</span>' +
          '<svg style="width: 1rem; height: 1rem;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' +
          '<polyline points="9 11 12 14 22 4"></polyline>' +
          '<path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>' +
          '</svg>';
      }
    }

    button.addEventListener('click', () => {
      const url = button.dataset.url;
      if (!url || button.disabled) {
        return;
      }
      setLoading(true);
      resultContainer.innerHTML = '';

      fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then((response) => {
          if (!response.ok) {
            throw new Error('Unable to run fairness analysis');
          }
          return response.text();
        })
        .then((html) => {
          resultContainer.innerHTML = html;
        })
        .catch(() => {
        resultContainer.innerHTML = '<div class="fairness-error">Unable to run the fairness analysis right now. Please try again in a few minutes.</div>';
      })
      .finally(() => {
        setLoading(false);
      });
    });
  })();
</script>
<script>
  (function () {
    const button = document.getElementById('comparables-more-button');

    if (!button) {
      return;
    }

    button.addEventListener('click', () => {
      if (button.disabled) {
        return;
      }

      button.disabled = true;
      const label = button.querySelector('.comparables-more-label');
      if (label) {
        label.textContent = 'Finding more comps…';
      } else {
        button.textContent = 'Finding more comps…';
      }

      const root = document.getElementById('appeal-comparables-root');
      const viewMode = (root && root.dataset.activeMode) || 'standard';
      const count = button.dataset.extendedCount;

      if (window.appealUpdateComparables) {
        window.appealUpdateComparables(viewMode, { count });
        return;
      }

      if (root && root.dataset.fetchUrl) {
        const params = new URLSearchParams();
        if (viewMode && viewMode !== 'standard') {
          params.set('view_mode', viewMode);
        }
        if (count) {
          params.set('count', count);
        }
        const query = params.toString();
        window.location.href = `${root.dataset.fetchUrl}${query ? `?${query}` : ''}`;
      }
    });
  })();
</script>
