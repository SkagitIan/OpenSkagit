{% load humanize formatting %}
{% with adj=comparable.adjustment_payload %}
<tr class="hover:bg-slate-900/60 transition">
    <td class="px-4 py-4 align-top">
        <button
            class="inline-flex items-center gap-2 text-xs text-rose-300 hover:text-rose-200 bg-rose-500/10 border border-rose-500/30 px-3 py-1 rounded-lg transition"
            hx-post="{% url 'cma-toggle-comp' parcel_number comparable.snapshot.parcel_number %}"
            hx-include="#cma-filter-form"
            hx-target="#cma-comparison-grid"
        >
            Remove
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
        </button>
        <p class="text-[11px] text-slate-500 mt-2 uppercase tracking-wide">Rank {{ comparable.inclusion_rank }}</p>
        {% if comparable.distance_miles %}
            <p class="text-[11px] text-slate-400 mt-1">{{ comparable.distance_miles }} mi away</p>
        {% endif %}
    </td>
    <td class="px-4 py-4 align-top">
        <p class="text-sm font-semibold text-white">{{ comparable.snapshot.address }}</p>
        <p class="text-xs text-slate-500 uppercase tracking-wide">Parcel {{ comparable.snapshot.parcel_number }}</p>
        {% if comparable.sale_date %}
            <p class="text-xs text-slate-500 mt-1">Sold {{ comparable.sale_date|date:"M j, Y" }}</p>
        {% endif %}
        <div
            class="mt-2 text-[11px] text-slate-400"
            hx-get="{% url 'cma-comparable-improvements' parcel_number comparable.snapshot.parcel_number %}?roll_id={{ comparable.snapshot.metadata.roll_id|default_if_none:'' }}&roll_year={{ comparable.snapshot.metadata.roll_year|default_if_none:'' }}{% if comparable.snapshot.metadata.assessor_building_style %}&assessor_style={{ comparable.snapshot.metadata.assessor_building_style|urlencode }}{% endif %}"
            hx-trigger="load"
            hx-target="this"
            hx-swap="outerHTML"
        >
            <span class="text-slate-500">Loading improvements…</span>
        </div>
    </td>
    <td class="px-4 py-4 align-top">
        <p class="text-sm font-semibold text-white">${{ comparable.sale_price|floatformat:0|intcomma }}</p>
        <p class="text-xs text-slate-500">
            Assessed:
            {% if comparable.assessed_value %}
                ${{ comparable.assessed_value|floatformat:0|intcomma }}
            {% else %}
                —
            {% endif %}
        </p>
        {% if advanced_mode and adj %}
            <p class="text-xs text-slate-500 mt-2">
                Adjusted:
                <span class="text-white font-semibold">${{ adj.adjusted_value|floatformat:0|intcomma }}</span>
                {% if adj.total_adjustment > 0 %}
                    <span class="ml-1 text-emerald-300">+${{ adj.total_adjustment|floatformat:0|intcomma }}</span>
                {% elif adj.total_adjustment < 0 %}
                    <span class="ml-1 text-rose-300">-${{ adj.total_adjustment|abs|floatformat:0|intcomma }}</span>
                {% else %}
                    <span class="ml-1 text-slate-400">$0</span>
                {% endif %}
            </p>
        {% endif %}
    </td>
    <td class="px-4 py-4 align-top">
        <div class="grid grid-cols-2 lg:grid-cols-3 gap-2 text-xs">
            <div class="rounded-lg px-3 py-2 border {% if comparable.difference_flags.living_area %}border-amber-400/40 bg-amber-500/10 text-amber-200{% else %}border-slate-800 bg-slate-950/40 text-slate-300{% endif %}">
                <p class="uppercase text-[10px] tracking-wide">Living area</p>
                <p class="font-semibold">
                    {% if subject.living_area %}{{ subject.living_area|floatformat:0|intcomma }}{% else %}—{% endif %}
                    /
                    {% if comparable.snapshot.living_area %}{{ comparable.snapshot.living_area|floatformat:0|intcomma }}{% else %}—{% endif %}
                </p>
                {% if advanced_mode and adj %}
                    {% with delta=adj.adjustments.area %}
                        {% if delta > 0 %}
                            <span class="mt-1 inline-flex text-[10px] px-2 py-0.5 rounded-full bg-emerald-500/10 text-emerald-200">+${{ delta|floatformat:0|intcomma }}</span>
                        {% elif delta < 0 %}
                            <span class="mt-1 inline-flex text-[10px] px-2 py-0.5 rounded-full bg-rose-500/10 text-rose-200">-${{ delta|abs|floatformat:0|intcomma }}</span>
                        {% endif %}
                    {% endwith %}
                {% endif %}
            </div>
            <div class="rounded-lg px-3 py-2 border {% if comparable.difference_flags.bedrooms %}border-amber-400/40 bg-amber-500/10 text-amber-200{% else %}border-slate-800 bg-slate-950/40 text-slate-300{% endif %}">
                <p class="uppercase text-[10px] tracking-wide">Beds</p>
                <p class="font-semibold">
                    {% if subject.bedrooms %}{{ subject.bedrooms|floatformat:0 }}{% else %}—{% endif %}
                    /
                    {% if comparable.snapshot.bedrooms %}{{ comparable.snapshot.bedrooms|floatformat:0 }}{% else %}—{% endif %}
                </p>
            </div>
            <div class="rounded-lg px-3 py-2 border {% if comparable.difference_flags.bathrooms %}border-amber-400/40 bg-amber-500/10 text-amber-200{% else %}border-slate-800 bg-slate-950/40 text-slate-300{% endif %}">
                <p class="uppercase text-[10px] tracking-wide">Baths</p>
                <p class="font-semibold">
                    {% if subject.bathrooms %}{{ subject.bathrooms|floatformat:1 }}{% else %}—{% endif %}
                    /
                    {% if comparable.snapshot.bathrooms %}{{ comparable.snapshot.bathrooms|floatformat:1 }}{% else %}—{% endif %}
                </p>
            </div>
            <div class="rounded-lg px-3 py-2 border {% if comparable.difference_flags.garage_sqft %}border-amber-400/40 bg-amber-500/10 text-amber-200{% else %}border-slate-800 bg-slate-950/40 text-slate-300{% endif %}">
                <p class="uppercase text-[10px] tracking-wide">Garage</p>
                <p class="font-semibold">
                    {% if subject.garage_sqft %}{{ subject.garage_sqft|floatformat:0|intcomma }}{% else %}—{% endif %}
                    /
                    {% if comparable.snapshot.garage_sqft %}{{ comparable.snapshot.garage_sqft|floatformat:0|intcomma }}{% else %}—{% endif %}
                </p>
                {% if advanced_mode and adj %}
                    {% with delta=adj.adjustments.garage %}
                        {% if delta > 0 %}
                            <span class="mt-1 inline-flex text-[10px] px-2 py-0.5 rounded-full bg-emerald-500/10 text-emerald-200">+${{ delta|floatformat:0|intcomma }}</span>
                        {% elif delta < 0 %}
                            <span class="mt-1 inline-flex text-[10px] px-2 py-0.5 rounded-full bg-rose-500/10 text-rose-200">-${{ delta|abs|floatformat:0|intcomma }}</span>
                        {% endif %}
                    {% endwith %}
                {% endif %}
            </div>
            <div class="rounded-lg px-3 py-2 border {% if comparable.difference_flags.acres %}border-amber-400/40 bg-amber-500/10 text-amber-200{% else %}border-slate-800 bg-slate-950/40 text-slate-300{% endif %}">
                <p class="uppercase text-[10px] tracking-wide">Lot size</p>
                <p class="font-semibold">
                    {% if subject.acres %}{{ subject.acres|floatformat:2 }}{% else %}—{% endif %}
                    /
                    {% if comparable.snapshot.acres %}{{ comparable.snapshot.acres|floatformat:2 }}{% else %}—{% endif %}
                </p>
                {% if advanced_mode and adj %}
                    {% with delta=adj.adjustments.lot %}
                        {% if delta > 0 %}
                            <span class="mt-1 inline-flex text-[10px] px-2 py-0.5 rounded-full bg-emerald-500/10 text-emerald-200">+${{ delta|floatformat:0|intcomma }}</span>
                        {% elif delta < 0 %}
                            <span class="mt-1 inline-flex text-[10px] px-2 py-0.5 rounded-full bg-rose-500/10 text-rose-200">-${{ delta|abs|floatformat:0|intcomma }}</span>
                        {% endif %}
                    {% endwith %}
                {% endif %}
            </div>
            <div class="rounded-lg px-3 py-2 border {% if comparable.difference_flags.year_built %}border-amber-400/40 bg-amber-500/10 text-amber-200{% else %}border-slate-800 bg-slate-950/40 text-slate-300{% endif %}">
                <p class="uppercase text-[10px] tracking-wide">Year built</p>
                <p class="font-semibold">
                    {% if subject.year_built %}{{ subject.year_built }}{% else %}—{% endif %}
                    /
                    {% if comparable.snapshot.year_built %}{{ comparable.snapshot.year_built }}{% else %}—{% endif %}
                </p>
                {% if advanced_mode and adj %}
                    {% with delta=adj.adjustments.age %}
                        {% if delta > 0 %}
                            <span class="mt-1 inline-flex text-[10px] px-2 py-0.5 rounded-full bg-emerald-500/10 text-emerald-200">+${{ delta|floatformat:0|intcomma }}</span>
                        {% elif delta < 0 %}
                            <span class="mt-1 inline-flex text-[10px] px-2 py-0.5 rounded-full bg-rose-500/10 text-rose-200">-${{ delta|abs|floatformat:0|intcomma }}</span>
                        {% endif %}
                    {% endwith %}
                {% endif %}
            </div>
        </div>
    </td>
    <td class="px-4 py-4 align-top">
        <p class="text-sm font-semibold text-white">Comparable insight</p>
        <p class="mt-2 text-xs text-slate-400">
            Sold {{ comparable.sale_date|date:"M j, Y" }} for {{ comparable.sale_price|floatformat:0|intcomma }}.
            {% if comparable.assessed_value %}
                County assessed at {{ comparable.assessed_value|floatformat:0|intcomma }}
                (Δ ${{ (comparable.sale_price - comparable.assessed_value)|floatformat:0|intcomma }}).
            {% endif %}
            {% if comparable.distance_miles %}
                Located {{ comparable.distance_miles }} miles from the subject.
            {% endif %}
        </p>
        {% if advanced_mode and adj and adj.adjustment_list %}
            <div class="mt-3 pt-3 border-t border-slate-800">
                <p class="text-[10px] uppercase tracking-wide text-slate-500">Adjustment breakdown</p>
                <dl class="mt-2 space-y-1 text-[11px]">
                    {% for item in adj.adjustment_list %}
                        {% if item.amount %}
                            <div class="flex items-center justify-between gap-2">
                                <dt class="text-slate-400">{{ item.label }}</dt>
                                <dd>
                                    {% if item.amount > 0 %}
                                        <span class="text-emerald-300">+${{ item.amount|floatformat:0|intcomma }}</span>
                                    {% elif item.amount < 0 %}
                                        <span class="text-rose-300">-${{ item.amount|abs|floatformat:0|intcomma }}</span>
                                    {% else %}
                                        <span class="text-slate-500">$0</span>
                                    {% endif %}
                                </dd>
                            </div>
                        {% endif %}
                    {% endfor %}
                </dl>
            </div>
        {% endif %}
    </td>
</tr>
{% endwith %}
