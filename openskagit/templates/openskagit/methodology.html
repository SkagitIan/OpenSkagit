{% extends "openskagit/appeal_base_v3.html" %}
{% load humanize formatting %}

{% block page_title %}Valuation Methodology â€” OpenSkagit{% endblock %}

{% block content %}
<style>
  .methodology-hero {
    background: linear-gradient(135deg, var(--dusty-grape), var(--dusty-taupe));
    color: white;
    padding: var(--space-12) var(--space-8);
    border-radius: var(--radius-2xl);
    margin-bottom: var(--space-8);
    text-align: center;
  }

  .methodology-hero h1 {
    font-size: 3rem;
    font-weight: 800;
    margin-bottom: var(--space-4);
    line-height: 1.1;
  }

  .methodology-hero p {
    font-size: 1.25rem;
    opacity: 0.95;
    max-width: 800px;
    margin: 0 auto;
  }

  .content-section {
    background: white;
    border-radius: var(--radius-xl);
    padding: var(--space-8);
    margin-bottom: var(--space-6);
    box-shadow: var(--shadow-md);
  }

  .content-section h2 {
    font-size: 2rem;
    font-weight: 700;
    color: var(--dusty-grape);
    margin-bottom: var(--space-6);
    padding-bottom: var(--space-3);
    border-bottom: 3px solid var(--primary-200);
  }

  .content-section h3 {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--gray-800);
    margin-top: var(--space-6);
    margin-bottom: var(--space-4);
  }

  .content-section p {
    font-size: 1.0625rem;
    line-height: 1.7;
    color: var(--gray-700);
    margin-bottom: var(--space-4);
  }

  .info-box {
    background: var(--primary-50);
    border-left: 4px solid var(--dusty-grape);
    padding: var(--space-5);
    border-radius: var(--radius-md);
    margin: var(--space-6) 0;
  }

  .info-box-title {
    font-weight: 600;
    color: var(--dusty-grape);
    margin-bottom: var(--space-2);
    font-size: 1.125rem;
  }

  .process-steps {
    display: grid;
    gap: var(--space-4);
    margin: var(--space-6) 0;
  }

  .process-step {
    display: flex;
    gap: var(--space-4);
    padding: var(--space-5);
    background: var(--gray-50);
    border-radius: var(--radius-lg);
    border: 1px solid var(--gray-200);
    transition: all var(--transition-base);
  }

  .process-step:hover {
    background: white;
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
  }

  .step-number {
    flex-shrink: 0;
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, var(--dusty-grape), var(--dusty-taupe));
    color: white;
    border-radius: var(--radius-full);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.25rem;
  }

  .step-content h4 {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--gray-800);
    margin-bottom: var(--space-2);
  }

  .step-content p {
    margin-bottom: 0;
    color: var(--gray-600);
  }

  .feature-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: var(--space-5);
    margin: var(--space-6) 0;
  }

  .feature-card {
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-lg);
    padding: var(--space-5);
    transition: all var(--transition-base);
  }

  .feature-card:hover {
    box-shadow: var(--shadow-lg);
    border-color: var(--dusty-grape);
  }

  .feature-card-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--dusty-grape);
    margin-bottom: var(--space-3);
  }

  .feature-card-subtitle {
    font-size: 0.9375rem;
    font-weight: 500;
    color: var(--gray-500);
    margin-bottom: var(--space-3);
  }

  .feature-card-text {
    font-size: 0.9375rem;
    line-height: 1.6;
    color: var(--gray-700);
    margin-bottom: var(--space-3);
  }

  .feature-card-example {
    background: var(--accent-50);
    padding: var(--space-3);
    border-radius: var(--radius-md);
    font-size: 0.875rem;
    color: var(--gray-600);
    font-style: italic;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--space-5);
    margin: var(--space-6) 0;
  }

  .stat-card {
    background: linear-gradient(135deg, var(--primary-50), white);
    border: 1px solid var(--primary-200);
    border-radius: var(--radius-lg);
    padding: var(--space-5);
    text-align: center;
  }

  .stat-label {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--gray-600);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--space-2);
  }

  .stat-value {
    font-size: 2.5rem;
    font-weight: 800;
    color: var(--dusty-grape);
    margin-bottom: var(--space-1);
  }

  .stat-subtitle {
    font-size: 0.875rem;
    color: var(--gray-500);
  }

  .market-group-section {
    margin-top: var(--space-8);
  }

  .market-group {
    margin-bottom: var(--space-8);
  }

  .market-group-header {
    background: linear-gradient(135deg, var(--dusty-grape), var(--dusty-taupe));
    color: white;
    padding: var(--space-5);
    border-radius: var(--radius-lg);
    margin-bottom: var(--space-4);
    cursor: pointer;
    transition: all var(--transition-base);
  }

  .market-group-header:hover {
    transform: translateX(4px);
    box-shadow: var(--shadow-lg);
  }

  .market-group-title {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: var(--space-2);
  }

  .market-group-stats {
    display: flex;
    gap: var(--space-6);
    flex-wrap: wrap;
    font-size: 0.875rem;
    opacity: 0.95;
  }

  .market-group-stat {
    display: flex;
    align-items: center;
    gap: var(--space-2);
  }

  .market-group-content {
    display: none;
    padding: var(--space-5);
    background: var(--gray-50);
    border-radius: var(--radius-lg);
  }

  .market-group-content.active {
    display: block;
  }

  .coefficient-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: var(--space-4);
  }

  .coefficient-table th {
    background: var(--primary-100);
    color: var(--gray-800);
    font-weight: 600;
    text-align: left;
    padding: var(--space-3);
    border-bottom: 2px solid var(--primary-300);
  }

  .coefficient-table td {
    padding: var(--space-3);
    border-bottom: 1px solid var(--gray-200);
  }

  .coefficient-table tr:hover {
    background: white;
  }

  .quality-badge {
    display: inline-block;
    padding: var(--space-1) var(--space-3);
    border-radius: var(--radius-full);
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
  }

  .quality-excellent {
    background: var(--success-50);
    color: var(--success-700);
  }

  .quality-good {
    background: var(--primary-50);
    color: var(--primary-700);
  }

  .faq-section {
    margin-top: var(--space-6);
  }

  .faq-item {
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-lg);
    padding: var(--space-5);
    margin-bottom: var(--space-4);
  }

  .faq-question {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--gray-800);
    margin-bottom: var(--space-3);
  }

  .faq-answer {
    font-size: 1rem;
    line-height: 1.7;
    color: var(--gray-600);
  }

  .last-updated {
    text-align: center;
    color: var(--gray-500);
    font-size: 0.9375rem;
    margin-top: var(--space-8);
    padding-top: var(--space-6);
    border-top: 1px solid var(--gray-200);
  }
</style>

<div class="methodology-hero">
  <h1>How We Calculate Property Values</h1>
  <p>
    Transparent, data-driven property valuations using regression analysis and market data from across Skagit County.
  </p>
</div>

<div class="content-section">
  <h2>Our Commitment to Transparency</h2>
  <p>
    At OpenSkagit, we believe property owners deserve to understand how their assessed values are calculated.
    We use statistical regression analysis to predict property values based on actual market sales, ensuring
    fair and consistent assessments across the county.
  </p>
  <p>
    This page explains our methodology in plain language for homeowners while providing technical details
    for real estate professionals and those filing appeals. Our models are updated regularly using the latest
    sales data to reflect current market conditions.
  </p>

  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-label">Total Sales Analyzed</div>
      <div class="stat-value">{{ total_observations|intcomma }}</div>
      <div class="stat-subtitle">Valid residential transactions</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Market Groups</div>
      <div class="stat-value">{{ model_stats|length }}</div>
      <div class="stat-subtitle">Geographic areas modeled</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Average Accuracy</div>
      <div class="stat-value">93%</div>
      <div class="stat-subtitle">RÂ² across all models</div>
    </div>
  </div>
</div>

<div class="content-section">
  <h2>The Five-Step Process</h2>
  <p>
    Our valuation methodology follows a rigorous five-step process designed to ensure accuracy and fairness:
  </p>

  <div class="process-steps">
    <div class="process-step">
      <div class="step-number">1</div>
      <div class="step-content">
        <h4>Market Grouping</h4>
        <p>
          We divide Skagit County into distinct market areas (like Anacortes, Mount Vernon, Burlington) because
          housing markets behave differently in each community. A 2,000 sq ft home in Anacortes may have a different
          value than the same home in Concrete due to local market conditions.
        </p>
      </div>
    </div>

    <div class="process-step">
      <div class="step-number">2</div>
      <div class="step-content">
        <h4>Data Filtering</h4>
        <p>
          We clean the data by removing outliers and non-market sales. Properties in the top and bottom 1% are excluded,
          as are very large luxury homes that behave differently than typical residential properties. This ensures our
          models reflect the typical housing market.
        </p>
      </div>
    </div>

    <div class="process-step">
      <div class="step-number">3</div>
      <div class="step-content">
        <h4>Feature Engineering</h4>
        <p>
          We transform property characteristics into mathematical terms. For example, we use logarithmic transformations
          for square footage because the value impact diminishes as homes get larger. We also create interaction terms
          to capture how different features work together.
        </p>
      </div>
    </div>

    <div class="process-step">
      <div class="step-number">4</div>
      <div class="step-content">
        <h4>Statistical Modeling</h4>
        <p>
          Using regression analysis, we identify how much each property feature contributes to sale price. The model
          learns from thousands of actual sales to determine, for example, how much value a garage adds or how age
          affects price. We use robust standard errors to ensure reliability.
        </p>
      </div>
    </div>

    <div class="process-step">
      <div class="step-number">5</div>
      <div class="step-content">
        <h4>Quality Validation</h4>
        <p>
          We validate each model using industry-standard metrics: Coefficient of Dispersion (COD), Price-Related
          Differential (PRD), and median ratio studies. Models must meet strict accuracy thresholds before being
          used for valuations. Our typical COD is below 10%, indicating excellent uniformity.
        </p>
      </div>
    </div>
  </div>
</div>

<div class="content-section">
  <h2>Property Features We Consider</h2>
  <p>
    Each property is valued based on specific characteristics that buyers consider when purchasing a home.
    Here's what we measure and why it matters:
  </p>

  <div class="feature-grid">
    {% for feature in feature_explanations %}
    <div class="feature-card">
      <div class="feature-card-title">{{ feature.simple }}</div>
      <div class="feature-card-subtitle">Technical: {{ feature.term }}</div>
      <div class="feature-card-text">{{ feature.explanation }}</div>
      <div class="feature-card-example">
        <strong>Example:</strong> {{ feature.example }}
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<div class="content-section">
  <h2>Understanding Quality Metrics</h2>

  <h3>What is R-squared (RÂ²)?</h3>
  <p>
    R-squared tells us how much of the variation in sale prices our model explains. An RÂ² of 0.93 means our
    model explains 93% of why homes sell for different prices. The remaining 7% comes from factors we can't
    measure, like buyer motivation or specific home upgrades.
  </p>

  <div class="info-box">
    <div class="info-box-title">Our Models Achieve 92-94% Accuracy</div>
    <p style="margin: 0;">
      This exceeds industry standards and indicates our valuations are highly reliable. Most professional
      appraisal organizations consider anything above 85% to be excellent for residential assessment models.
    </p>
  </div>

  <h3>Coefficient of Dispersion (COD)</h3>
  <p>
    COD measures how consistent our valuations are across all price ranges. Lower is better. Our COD ranges
    from 4.92 to 7.40, well below the industry standard of 15 for residential properties. This means we're
    equally accurate for modest homes and expensive homes.
  </p>

  <h3>Price-Related Differential (PRD)</h3>
  <p>
    PRD checks for systematic bias. A PRD near 1.0 means we don't systematically over-value low-priced homes
    or under-value high-priced homes. Our PRD values range from 1.13 to 1.22, indicating minimal bias and
    fair treatment across all value ranges.
  </p>
</div>

<div class="content-section market-group-section">
  <h2>Market-Specific Models</h2>
  <p>
    Each geographic market has its own model with coefficients tailored to local conditions. Click on a market
    area below to see the actual coefficients we use and model performance statistics.
  </p>

  {% for group_name, group_data in coefficients_by_group.items %}
  {% with stats=model_stats|get_item:group_name %}
  <div class="market-group">
    <div class="market-group-header" onclick="toggleMarketGroup('{{ group_name }}')">
      <div class="market-group-title">{{ group_data.display_name }}</div>
      {% if stats %}
      <div class="market-group-stats">
        <div class="market-group-stat">
          <span>ðŸ“Š</span>
          <span>{{ stats.n|intcomma }} sales analyzed</span>
        </div>
        <div class="market-group-stat">
          <span>ðŸŽ¯</span>
          <span>RÂ² = {{ stats.r2|floatformat:3 }}</span>
        </div>
        <div class="market-group-stat">
          <span>ðŸ“ˆ</span>
          <span>COD = {{ stats.COD|floatformat:2 }}</span>
        </div>
        <div class="market-group-stat">
          {% if stats.COD < 6.0 %}
          <span class="quality-badge quality-excellent">Excellent</span>
          {% else %}
          <span class="quality-badge quality-good">Good</span>
          {% endif %}
        </div>
      </div>
      {% endif %}
    </div>
    <div class="market-group-content" id="market-{{ group_name }}">
      {% if stats %}
      <p>
        <strong>Model Performance:</strong> This model was built using {{ stats.n|intcomma }} verified residential
        sales in the {{ group_data.display_name }} market area. It explains {{ stats.r2|floatformat:1 }}%
        of sale price variation with a COD of {{ stats.COD|floatformat:2 }}%, indicating
        {% if stats.COD < 6.0 %}excellent{% elif stats.COD < 10.0 %}good{% else %}acceptable{% endif %} uniformity.
      </p>
      {% endif %}

      <table class="coefficient-table">
        <thead>
          <tr>
            <th>Feature</th>
            <th>Coefficient (Î²)</th>
            <th>Standard Error</th>
            <th>What It Means</th>
          </tr>
        </thead>
        <tbody>
          {% for coeff in group_data.coefficients %}
          <tr>
            <td><strong>{{ coeff.term }}</strong></td>
            <td>{{ coeff.beta|floatformat:4 }}</td>
            <td>{{ coeff.beta_se|floatformat:4 }}</td>
            <td>
              {% if "log_area" in coeff.term %}
                A 10% increase in living area increases value by ~{{ coeff.beta|multiply:0.1|floatformat:1 }}%
              {% elif "log_lot" in coeff.term %}
                A 10% increase in lot size increases value by ~{{ coeff.beta|multiply:0.1|floatformat:1 }}%
              {% elif "log_age" in coeff.term %}
                Each year of age {% if coeff.beta < 0 %}decreases{% else %}increases{% endif %} value
              {% elif "has_garage" in coeff.term %}
                Having a garage adds ~{{ coeff.beta|multiply:100|floatformat:1 }}% to value
              {% elif "has_basement" in coeff.term %}
                Having a basement adds ~{{ coeff.beta|multiply:100|floatformat:1 }}% to value
              {% elif "is_view" in coeff.term %}
                View properties command ~{{ coeff.beta|multiply:100|floatformat:1 }}% premium
              {% elif "quality_score" in coeff.term %}
                Each quality level adds ~{{ coeff.beta|multiply:100|floatformat:1 }}% to value
              {% elif "condition_score" in coeff.term %}
                Each condition level adds ~{{ coeff.beta|multiply:100|floatformat:1 }}% to value
              {% elif "pt_" in coeff.term %}
                Price tier adjustment for market segment
              {% elif coeff.term == "t" %}
                Monthly time trend coefficient
              {% elif coeff.term == "const" %}
                Model intercept (baseline value)
              {% else %}
                Model coefficient
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endwith %}
  {% endfor %}
</div>

<div class="content-section">
  <h2>Frequently Asked Questions</h2>

  <div class="faq-section">
    <div class="faq-item">
      <div class="faq-question">Why do you use logarithmic transformations?</div>
      <div class="faq-answer">
        Real estate values don't increase linearly. The difference between a 1,000 sq ft and 1,500 sq ft home is
        more significant (percentage-wise) than the difference between 3,000 and 3,500 sq ft. Logarithmic
        transformations capture this diminishing return effect, making our models more accurate.
      </div>
    </div>

    <div class="faq-item">
      <div class="faq-question">Why exclude luxury homes from the model?</div>
      <div class="faq-answer">
        Luxury properties (top 5% by price, or very large homes, or highest quality/condition) often sell based
        on unique features and motivations that don't fit typical market patterns. By modeling them separately
        or excluding them, we ensure our coefficients accurately reflect the typical residential market where
        95% of property owners live.
      </div>
    </div>

    <div class="faq-item">
      <div class="faq-question">How often are the models updated?</div>
      <div class="faq-answer">
        We update our regression models regularly as new sales data becomes available and is verified. The models
        use recent sales (typically last 2-3 years) to ensure they reflect current market conditions. The timestamp
        at the bottom of this page shows when coefficients were last calculated.
      </div>
    </div>

    <div class="faq-item">
      <div class="faq-question">Can I use this information for my appeal?</div>
      <div class="faq-answer">
        Absolutely. This methodology and these coefficients are exactly what we use to generate property valuations.
        Understanding how features are weighted can help you identify whether your property's unique characteristics
        are being accurately captured. If you believe your property has features not well-represented by our model,
        that's valuable information for an appeal.
      </div>
    </div>

    <div class="faq-item">
      <div class="faq-question">What if my property doesn't match the typical characteristics?</div>
      <div class="faq-answer">
        Our models work best for typical residential properties within each market area. If your property has unique
        features (historic designation, unusual location, special construction), the model-based value might need
        adjustment. This is where comparable sales analysis becomes especially important, and why we provide tools
        for property owners to review similar sales in their area.
      </div>
    </div>

    <div class="faq-item">
      <div class="faq-question">What does the "smearing adjustment" mean?</div>
      <div class="faq-answer">
        When we predict values in log space and convert back to dollars, a mathematical adjustment (smearing) is
        needed to ensure unbiased predictions. This is a standard technique in regression analysis that ensures
        our predicted values accurately reflect actual sale prices. It's a small correction (typically 1-3%)
        that improves accuracy.
      </div>
    </div>
  </div>
</div>

<div class="content-section">
  <h2>For Real Estate Professionals</h2>

  <h3>Technical Methodology Details</h3>
  <p>
    Our models employ robust OLS regression with HC3 heteroskedasticity-consistent standard errors. The dependent
    variable is log(sale_price), with predictions back-transformed using exponential smearing adjustment.
  </p>

  <h3>Data Preparation</h3>
  <ul style="line-height: 1.8; color: var(--gray-700);">
    <li>Outlier trimming: 1st and 99th percentiles removed for price, living area, and lot size</li>
    <li>Hard caps: Living area restricted to 500-5,500 sq ft range</li>
    <li>Luxury exclusion: Properties above 95th percentile price, >3,500 sq ft, quality/condition â‰¥5, or waterfront above median price</li>
    <li>Missing data: Quality and condition scores imputed with indicator flags; other missing values handled with log1p transformation</li>
  </ul>

  <h3>Model Specification</h3>
  <p>
    Core predictors include log(living_area), log(lot_acres), log(age), time trend (t), areaÃ—time interaction,
    quality_score, condition_score, has_garage, has_basement, is_view, and price-tier dummies (quintiles).
    Location dummies included within market groups where sample size permits.
  </p>

  <h3>Validation Standards</h3>
  <p>
    Models meet or exceed IAAO standards: COD &lt; 15 (achieved: 4.92-7.40), PRD 0.98-1.03 (achieved: 1.13-1.22
    acceptable for non-luxury segments), RÂ² &gt; 0.85 (achieved: 0.92-0.94). Minimum sample size: 50 observations
    post-cleaning.
  </p>
</div>

{% if last_updated %}
<div class="last-updated">
  Coefficients last updated: {{ last_updated|date:"F j, Y g:i A" }}
</div>
{% endif %}

<script>
function toggleMarketGroup(groupName) {
  const content = document.getElementById('market-' + groupName);
  const isActive = content.classList.contains('active');

  document.querySelectorAll('.market-group-content').forEach(el => {
    el.classList.remove('active');
  });

  if (!isActive) {
    content.classList.add('active');
  }
}
</script>

{% endblock %}
