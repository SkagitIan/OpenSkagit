{% extends "openskagit/appeal_base_v3.html" %}
{% load static humanize %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'openskagit/portal.css' %}" />
  <link rel="stylesheet" href="{% static 'openskagit/methodology.css' %}" />
{% endblock %}

{% block page_title %}Valuation Methodology — OpenSkagit{% endblock %}

{% block content %}
<section class="stats-hero">
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-value">{{ total_observations|intcomma }}</div>
      <div class="stat-label">Sales Analyzed</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">{{ adjustment_run_stats|length }}</div>
      <div class="stat-label">Active Segments</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">
        {% if last_updated %}{{ last_updated|date:"M j, Y" }}{% else %}TBD{% endif %}
      </div>
      <div class="stat-label">Latest Refresh</div>
    </div>
  </div>
  <div class="stats-timestamp">
    {% if last_updated %}
      <i class="fa-regular fa-clock"></i> Updated {{ last_updated|date:"F j, Y g:i A" }}
    {% endif %}
  </div>
</section>

<section class="pipeline-visual">
  <h2>How We Build Your Data</h2>

  <div class="pipeline-timeline">
    <div class="timeline-line"></div>

    <div class="pipeline-node" data-step="1">
      <div class="node-circle">
        <i class="fa-solid fa-cloud-arrow-down"></i>
      </div>
      <div class="node-content">
        <h3>Collect</h3>
        <p>County records & GIS data</p>
      </div>
    </div>

    <div class="pipeline-node" data-step="2">
      <div class="node-circle">
        <i class="fa-solid fa-broom"></i>
      </div>
      <div class="node-content">
        <h3>Clean</h3>
        <p>Normalize & reconcile</p>
      </div>
    </div>

    <div class="pipeline-node" data-step="3">
      <div class="node-circle">
        <i class="fa-solid fa-location-crosshairs"></i>
      </div>
      <div class="node-content">
        <h3>Geo Tag</h3>
        <p>Terrain & distance</p>
      </div>
    </div>

    <div class="pipeline-node" data-step="4">
      <div class="node-circle">
        <i class="fa-solid fa-layer-group"></i>
      </div>
      <div class="node-content">
        <h3>Enrich</h3>
        <p>Census & economic</p>
      </div>
    </div>

    <div class="pipeline-node" data-step="5">
      <div class="node-circle">
        <i class="fa-solid fa-toolbox"></i>
      </div>
      <div class="node-content">
        <h3>Build Tools</h3>
        <p>Reports & analysis</p>
      </div>
    </div>

    <div class="pipeline-node" data-step="6">
      <div class="node-circle">
        <i class="fa-solid fa-robot"></i>
      </div>
      <div class="node-content">
        <h3>AI Assist</h3>
        <p>Verified insights</p>
      </div>
    </div>
  </div>

  <div class="pipeline-detail" id="pipelineDetail">
    <div class="detail-content"></div>
  </div>
</section>

<section class="card table-card">
    <div class="section-head">
      <div>
        <p class="section-eyebrow">Diagnostics snapshot</p>
        <h2>Latest adjustment run statistics</h2>
      </div>
      <p class="section-subtitle">
        A compact, responsive view of the newest diagnostics. Colors key off IAAO targets so you can quickly scan
        which segments are on track.
      </p>
    </div>

    <div class="table-shell bg-white border border-[#dbe7dd] rounded-2xl shadow-xl overflow-hidden">
      <div class="table-legend flex flex-wrap items-center gap-3 text-sm">
        <span class="legend-item">
          <span class="legend-dot" aria-hidden="true"></span>
          Within IAAO range
        </span>
        <span class="legend-item">
          <span class="legend-dot legend-dot--watch" aria-hidden="true"></span>
          Outside IAAO range
        </span>
        <span class="legend-note">
          COD ≤ 15 · PRD 0.98–1.03 · PRB −0.05–0.05 · Median ratio 0.90–1.10
        </span>
      </div>
      <div class="table-wrapper overflow-x-auto">
        <table class="diagnostic-table text-sm w-full" aria-live="polite">
          <thead>
            <tr>
              <th scope="col">Segment</th>
              <th scope="col">Sales</th>
              <th scope="col">R²</th>
              <th scope="col">COD</th>
              <th scope="col">PRD</th>
              <th scope="col">PRB</th>
              <th scope="col">Median</th>
              <th scope="col">Price band</th>
            </tr>
          </thead>
          <tbody id="adjustment-stats-body">
            <tr id="adjustment-stats-empty">
              <td colspan="8" class="table-empty">Adjustment run data is still being prepared.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="table-footer">
      {% if latest_adjustment_run %}
        <span>Run {{ latest_adjustment_run.run_id }}</span>
        <span>Refreshed {{ latest_adjustment_run.created_at|date:"F j, Y g:i A" }}</span>
        <span>{{ adjustment_run_stats|length }} rows</span>
      {% else %}
        <span>Adjustment run data is still being prepared.</span>
      {% endif %}
    </div>
  </section>

<section class="card feature-section">
  <div class="bg-white shadow rounded-xl p-6 space-y-6">
    <h2 class="text-2xl font-bold text-gray-800">Regression Diagnostics</h2>

    <div class="chart-controls flex flex-wrap gap-4">
      <button
        data-chart="ratio_dist"
        data-title="Ratio Distribution"
        data-body="Histogram of sale-to-value ratios so you can confirm the center, spread, and skew of the model."
        data-support="A balanced model has a narrow bell curve, meaning extreme under- or over-valuations are rare."
        data-ideal="Ideal: ratios stack between 0.95 and 1.05 with the median pinned near 1.00."
        class="chart-btn px-5 py-2.5 rounded-lg bg-[#7FA693] text-white text-sm font-medium shadow-sm"
      >
        Ratio Distribution
      </button>

      <button
        data-chart="ratio_vs_value"
        data-title="Ratio vs Value"
        data-body="Each dot compares a sale ratio to its predicted value to surface price-related bias (PRB)."
        data-support="Use this view to confirm calibration keeps luxury homes and entry-level homes aligned to the target ratio."
        data-ideal="Ideal: a horizontal cloud centered on 1.00 with no upward or downward slope."
        class="chart-btn px-5 py-2.5 rounded-lg bg-gray-200 text-gray-700 text-sm font-medium"
      >
        Ratio vs Value
      </button>

      <button
        data-chart="residuals"
        data-title="Residuals"
        data-body="Residuals show the dollar difference between the actual sale price and the predicted price."
        data-support="Large outliers hint at parcels that need closer review or features missing from the regression."
        data-ideal="Ideal: residuals scatter randomly around zero with symmetric spread."
        class="chart-btn px-5 py-2.5 rounded-lg bg-gray-200 text-gray-700 text-sm font-medium"
      >
        Residuals
      </button>

      <button
        data-chart="area_bias"
        data-title="Area Bias"
        data-body="Ratios plotted against log living area reveal whether small, mid, or large homes lean off-ratio."
        data-support="Reviewing this tab confirms size calibrations keep cottages and custom homes on the same footing."
        data-ideal="Ideal: ratios sit near 1.00 across the entire area range with no tilt."
        class="chart-btn px-5 py-2.5 rounded-lg bg-gray-200 text-gray-700 text-sm font-medium"
      >
        Area Bias
      </button>

      <button
        data-chart="time_trend"
        data-title="Time Trend"
        data-body="Ratios compared against the time index verify that the time-adjustment keeps up with market movement."
        data-support="Look for drift up or down to know when the appreciation factor needs to be refreshed."
        data-ideal="Ideal: ratios stay centered on 1.00 throughout the study period."
        class="chart-btn px-5 py-2.5 rounded-lg bg-gray-200 text-gray-700 text-sm font-medium"
      >
        Time Trend
      </button>
    </div>

    <div class="chart-description">
      <h3 id="chartDescriptionTitle" class="chart-description-title">Ratio Distribution</h3>
      <p id="chartDescriptionBody" class="chart-description-body">
        Histogram of sale-to-value ratios so you can confirm the center, spread, and skew of the model.
      </p>
      <p id="chartDescriptionSupport" class="chart-description-body">
        A balanced model has a narrow bell curve, meaning extreme under- or over-valuations are rare.
      </p>
      <p id="chartDescriptionIdeal" class="chart-description-ideal">
        Ideal: ratios stack between 0.95 and 1.05 with the median pinned near 1.00.
      </p>
    </div>

    <div>
      <canvas id="raChart" class="w-full h-96"></canvas>
    </div>
  </div>
</section>

  <section class="card feature-section">
    <div class="section-head">
      <div>
        <p class="section-eyebrow">Features explained</p>
        <h2>Predictors that power the regression</h2>
      </div>
      <p class="section-subtitle">
        Each predictor now lives in a single responsive row with room for future stats, so you can skim their roles at a glance.
      </p>
    </div>
    <div class="mt-6 rounded-2xl border border-[#dbe7dd] bg-white shadow-xl">
      <div class="overflow-x-auto">
        <table class="min-w-full text-left text-sm">
          <thead class="bg-[#f7faf6] text-[0.75rem] uppercase tracking-[0.18em] text-[#1f3327]">
            <tr>
              <th scope="col" class="px-4 py-3 font-semibold">Predictor</th>
              <th scope="col" class="px-4 py-3 font-semibold">Why it matters</th>
              <th scope="col" class="px-4 py-3 font-semibold">Driver group</th>
              <th scope="col" class="px-4 py-3 font-semibold">Direction</th>
              <th scope="col" class="px-4 py-3 font-semibold">Importance</th>
              <th scope="col" class="px-4 py-3 font-semibold">Stat A (TBD)</th>
              <th scope="col" class="px-4 py-3 font-semibold">Stat B (TBD)</th>
            </tr>
          </thead>
          <tbody>
            {% for driver in value_driver_rows %}
              <tr class="border-b border-[#eef3ed] last:border-none transition-colors hover:bg-[#f8fbf8]">
                <td class="px-4 py-4 align-top">
                  <div class="text-base font-semibold text-[#1f3327]">{{ driver.label }}</div>
                  <div class="text-[0.65rem] uppercase tracking-[0.3em] text-[#7f8e82]">{{ driver.term|default:""|upper }}</div>
                </td>
                <td class="px-4 py-4 align-top text-sm text-gray-700 max-w-xl">
                  {{ driver.description|default:"Details coming soon."|truncatechars:120 }}
                </td>
                <td class="px-4 py-4 align-top">
                  <span class="inline-flex items-center rounded-full border border-[#dbe7dd] bg-[#f7faf6] px-3 py-1 text-xs font-semibold text-[#1f3327] tracking-wide">
                    {{ driver.group_label }}
                  </span>
                </td>
                <td class="px-4 py-4 align-top">
                  {% if driver.direction == 'lower' %}
                    <span class="inline-flex items-center rounded-full border border-emerald-200 bg-emerald-50 px-3 py-1 text-xs font-semibold text-emerald-700">
                      Pulls ratios lower
                    </span>
                  {% elif driver.direction == 'higher' %}
                    <span class="inline-flex items-center rounded-full border border-amber-200 bg-amber-50 px-3 py-1 text-xs font-semibold text-amber-700">
                      Pushes ratios higher
                    </span>
                  {% else %}
                    <span class="inline-flex items-center rounded-full border border-gray-200 bg-gray-50 px-3 py-1 text-xs font-semibold text-gray-700">
                      Mixed influence
                    </span>
                  {% endif %}
                </td>
                <td class="px-4 py-4 align-top">
                  {% if driver.importance_pct is not None %}
                    <div class="text-lg font-semibold text-[#1f3327]">{{ driver.importance_pct|floatformat:1 }}%</div>
                    <div class="text-xs text-gray-500">Model share</div>
                  {% else %}
                    <div class="text-sm text-gray-500">—</div>
                  {% endif %}
                </td>
                <td class="px-4 py-4 align-top text-sm text-gray-500">—</td>
                <td class="px-4 py-4 align-top text-sm text-gray-500">—</td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="7" class="px-4 py-6 text-center text-sm text-gray-500">
                  Predictor diagnostics are still loading.
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </section>


{% endblock %}

{% block extra_js %}
<script>
  window.tailwind = window.tailwind || {};
  window.tailwind.config = {
    corePlugins: { preflight: false },
  };
</script>
<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

<script id="methodology-run-stats-data" type="application/json">
  {{ adjustment_run_stats_json|safe }}
</script>

<script>
  window.chartData = {{ chart_data|safe }};
</script>
<script src="{% static 'openskagit/js/ra_charts.js' %}"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const detailElement = document.getElementById("pipelineDetail");
    const detailContent = detailElement ? detailElement.querySelector(".detail-content") : null;
    const pipelineNodes = Array.from(document.querySelectorAll(".pipeline-node"));

    const pipelineDetails = {
      '1': `
      We ingest authoritative public records from Skagit County and related agencies, including assessor parcels, sales records, GIS layers, zoning, flood data, and planning overlays. 
      Sources are pulled directly from county databases, ArcGIS REST services, and published datasets, preserving original attributes and geometry.
      All raw data is stored intact to ensure traceability back to the source.
        `,
      '2': `
      Incoming datasets are standardized, reconciled, and validated through repeatable pipelines. 
      Parcel identifiers are aligned across systems, geometry is reprojected and indexed, and schema mismatches are resolved.
      We log row counts, coverage gaps, conflicts, and anomalies so data quality issues are visible—not hidden.
        `,
      '3': `
      Every parcel is spatially enriched using PostGIS and derived geometry.
      We calculate terrain characteristics (elevation, slope, aspect), distances to features like shorelines, rivers, roads, utilities, and jurisdictional boundaries, and apply spatial joins for flood zones, zoning, and environmental constraints.
      These metrics are computed—not guessed—and can be recomputed as better data becomes available.
        `,
      '4': `
      Parcel-level data is contextualized with demographic, economic, and regulatory information.
      This includes census statistics, neighborhood aggregates, planning designations, water and environmental constraints, and historical trends.
      The goal is to move beyond raw parcels into explainable, comparable context across neighborhoods and time.
        `,
      '5': `
      This foundation powers analytical tools such as parcel insights, neighborhood profiles, valuation diagnostics, planning and buildability analysis, and fairness metrics.
      Because the data model is parcel-centric and normalized, tools can evolve without reworking the underlying data.
      What you see is built directly on the same data professionals use.
        `,
      '6': `
      AI is used to assist with summarization, pattern detection, and narrative generation—but never as an unverified source of truth.
      All AI outputs are grounded in the underlying data and designed to be explainable.
      Automation supports analysis; it does not replace accountability or judgment.
        `,
    };

    if (detailElement && detailContent && pipelineNodes.length) {
      pipelineNodes.forEach((node) => {
        node.addEventListener("click", () => {
          const step = node.dataset.step;
          detailContent.textContent = (pipelineDetails[step] || "").trim();
          detailElement.classList.add("active");

          if (window.innerWidth <= 768) {
            setTimeout(() => {
              detailElement.scrollIntoView({ behavior: "smooth", block: "nearest" });
            }, 100);
          }
        });
      });
    }

    const dataElement = document.getElementById("methodology-run-stats-data");
    const tableBody = document.getElementById("adjustment-stats-body");
    const emptyRow = document.getElementById("adjustment-stats-empty");

    if (!dataElement || !tableBody) {
      return;
    }

    let diagnostics = [];
    try {
      diagnostics = dataElement.textContent ? JSON.parse(dataElement.textContent) : [];
    } catch (error) {
      diagnostics = [];
      console.error("Failed to parse adjustment run stats JSON.", error);
    }

    if (!Array.isArray(diagnostics) || diagnostics.length === 0) {
      return;
    }

    if (emptyRow) {
      emptyRow.remove();
    }

    const integerFormatter = new Intl.NumberFormat("en-US");
    const currencyFormatter = new Intl.NumberFormat("en-US", {
      style: "currency",
      currency: "USD",
      maximumFractionDigits: 0,
    });

    const marketPrefixes = {
      MOUNT_VERNON: "MV",
      SEDRO_WOOLLEY: "SW",
      BURLINGTON: "BURL",
      ANACORTES: "ANA",
      CONCRETE: "CON",
      LACONNER_CONWAY: "LACO",
      COUNTYWIDE: "CTY",
    };

    const tierLabels = {
      T1_LOW: "LOW",
      T2_MID: "MID",
      T3_HIGH: "HIGH",
      T4_LUX: "LUX",
      T5_ULTRA: "ULTRA",
      ALL: "ALL",
    };

    const titleize = (value) => {
      if (!value) return "—";
      return value
        .toString()
        .replace(/_/g, " ")
        .toLowerCase()
        .split(" ")
        .map((word) => (word ? word[0].toUpperCase() + word.slice(1) : ""))
        .join(" ");
    };

    const normalizeTier = (tier) => {
      if (!tier) return "NA";
      const cleaned = tierLabels[tier] || tier.replace(/^T\d+_/, "").replace(/_/g, "-");
      return cleaned.toUpperCase();
    };

    const descriptorForRow = (row) => {
      const marketKey = row?.market_group || "";
      const market = marketPrefixes[marketKey] || marketKey.slice(0, 4).toUpperCase() || "SEG";
      const tier = normalizeTier(row?.value_tier);
      return `${market}-${tier}`;
    };

    const formatInteger = (value) => {
      const numeric = Number(value);
      if (!Number.isFinite(numeric)) return "—";
      return integerFormatter.format(numeric);
    };

    const formatDecimal = (value, precision = 2) => {
      const numeric = Number(value);
      if (!Number.isFinite(numeric)) return "—";
      return numeric.toFixed(precision);
    };

    const formatMetric = (metric, value) => {
      if (value === null || value === undefined) {
        return "—";
      }
      if (metric === "COD") {
        const numeric = Number(value);
        return Number.isFinite(numeric) ? `${numeric.toFixed(2)}%` : "—";
      }
      if (metric === "median_ratio") {
        return formatDecimal(value, 3);
      }
      const precision = metric === "PRB" ? 3 : 3;
      return formatDecimal(value, precision);
    };

    const withinIAAO = {
      COD: (v) => Number.isFinite(v) && v <= 15,
      PRD: (v) => Number.isFinite(v) && v >= 0.98 && v <= 1.03,
      PRB: (v) => Number.isFinite(v) && v >= -0.05 && v <= 0.05,
      median_ratio: (v) => Number.isFinite(v) && v >= 0.9 && v <= 1.1,
    };

    const classForMetric = (metric, value) => {
      const numeric = Number(value);
      if (!Number.isFinite(numeric) || !withinIAAO[metric]) {
        return "iaao-muted";
      }
      return withinIAAO[metric](numeric) ? "iaao-pass" : "iaao-watch";
    };

    const formatRange = (min, max) => {
      const low = Number(min);
      const high = Number(max);
      if (!Number.isFinite(low) || !Number.isFinite(high)) {
        return "—";
      }
      return `${currencyFormatter.format(low)} – ${currencyFormatter.format(high)}`;
    };

    const sortedDiagnostics = diagnostics
      .slice()
      .sort((a, b) => {
        const marketCompare = String(a.market_group || "").localeCompare(String(b.market_group || ""));
        if (marketCompare !== 0) return marketCompare;
        return String(a.value_tier || "").localeCompare(String(b.value_tier || ""));
      });

    sortedDiagnostics.forEach((row) => {
      const descriptor = descriptorForRow(row);
      const tierPretty = titleize(row?.value_tier);
      const marketPretty = titleize(row?.market_group);

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>
          <div class="segment-tag">${descriptor}</div>
          <span class="segment-subtext">${marketPretty} · ${tierPretty}</span>
        </td>
        <td class="stat-metric">${formatInteger(row?.n)}</td>
        <td class="stat-metric">
          <div>${formatDecimal(row?.r2, 3)}</div>
          <span class="segment-subtext">Adj ${formatDecimal(row?.adj_r2, 3)}</span>
        </td>
        <td class="stat-metric ${classForMetric("COD", row?.COD)}">${formatMetric("COD", row?.COD)}</td>
        <td class="stat-metric ${classForMetric("PRD", row?.PRD)}">${formatMetric("PRD", row?.PRD)}</td>
        <td class="stat-metric ${classForMetric("PRB", row?.PRB)}">${formatMetric("PRB", row?.PRB)}</td>
        <td class="stat-metric ${classForMetric("median_ratio", row?.median_ratio)}">${formatMetric("median_ratio", row?.median_ratio)}</td>
        <td>
          <span class="range-pill"><span>Range</span>${formatRange(row?.price_min, row?.price_max)}</span>
        </td>
      `;
      tableBody.appendChild(tr);
    });
  });
</script>
{% endblock %}
