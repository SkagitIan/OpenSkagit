{% extends "openskagit/appeal_base_v3.html" %}
{% load static humanize %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'openskagit/portal.css' %}" />
  <style>
    .methodology-hero {
      background: linear-gradient(135deg, #6B9080 0%, #7FA693 100%) !important;
      color: #fff !important;
      border: none !important;
      padding: 2.75rem 2.5rem;
      border-radius: 1.5rem;
      overflow: hidden;
      position: relative;
      box-shadow: 0 25px 35px rgba(25, 44, 33, 0.2);
    }

    .methodology-hero::after {
      content: "";
      position: absolute;
      inset: 1rem;
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 1.25rem;
      pointer-events: none;
    }

    .hero-top-line {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      font-size: 0.85rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      opacity: 0.85;
      font-weight: 600;
    }

    .hero-top-line span:last-child {
      font-size: 0.9rem;
      letter-spacing: 0.15em;
    }

    .methodology-hero h1 {
      font-size: clamp(2rem, 4vw, 3rem);
      margin: 1rem 0 1rem;
      line-height: 1.2;
      font-weight: 800;
    }

    .methodology-hero p {
      max-width: 760px;
      font-size: 1.05rem;
      line-height: 1.7;
      color: rgba(255, 255, 255, 0.9);
    }

    .hero-note {
      font-size: 0.95rem;
      color: rgba(255, 255, 255, 0.75);
      margin-top: 0.5rem;
    }

    .hero-metrics {
      margin-top: 1.75rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
    }

    .hero-metric {
      background: rgba(255, 255, 255, 0.15);
      border-radius: 1rem;
      padding: 1rem;
      border: 1px solid rgba(255, 255, 255, 0.25);
    }

    .hero-metric-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.2em;
      opacity: 0.85;
    }

    .hero-metric-value {
      font-size: 1.8rem;
      font-weight: 700;
      margin: 0.35rem 0;
    }

    .hero-metric-note {
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.85);
    }

    .section-eyebrow {
      text-transform: uppercase;
      letter-spacing: 0.18em;
      font-size: 0.75rem;
      color: #4a5f52;
      font-weight: 600;
    }

    .section-head {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .section-head h2 {
      margin: 0.15rem 0;
      font-size: 1.8rem;
      font-weight: 700;
      color: #1f3327;
    }

    .section-subtitle {
      color: var(--gray-600);
      max-width: 60ch;
      margin: 0;
    }

    .trust-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 2rem;
    }

    .trust-list {
      list-style: none;
      padding: 0;
      margin: 1.1rem 0 0;
      display: grid;
      gap: 0.85rem;
      line-height: 1.6;
      color: var(--gray-700);
    }

    .trust-list li {
      position: relative;
      padding-left: 1.35rem;
    }

    .trust-list li::before {
      content: "•";
      position: absolute;
      left: 0;
      color: #6B9080;
      font-size: 1.2rem;
      top: -0.1rem;
    }

    .trust-pill-grid {
      display: grid;
      gap: 1rem;
    }

    .trust-pill {
      border-radius: 1rem;
      border: 1px solid #d4e4db;
      padding: 1rem 1.25rem;
      background: #f7faf6;
      min-height: 110px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 0.1rem;
    }

    .trust-pill span {
      font-size: 0.75rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: #55706a;
    }

    .trust-pill strong {
      font-size: 1.5rem;
      color: #1f3327;
      display: block;
    }

    .trust-pill p {
      margin: 0;
      color: var(--gray-600);
      font-size: 0.9rem;
    }

    .model-health-grid {
      margin-top: 1.25rem;
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    .model-health-card {
      border-radius: 1rem;
      border: 1px solid #e0e6dd;
      padding: 1.25rem;
      background: #fff;
      box-shadow: var(--shadow-sm);
    }

    .model-health-card h3 {
      margin: 0;
      font-size: 1.2rem;
      color: #274d34;
    }

    .model-sample {
      margin: 0.3rem 0 0.65rem;
      color: var(--gray-600);
      font-weight: 600;
    }

    .model-health-metrics {
      display: flex;
      flex-wrap: wrap;
      gap: 0.85rem;
      font-size: 0.95rem;
    }

    .model-health-metrics span {
      color: #2c4132;
    }

    .feature-grid {
      margin-top: 1.5rem;
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    }

    .feature-card {
      border-radius: 1.1rem;
      border: 1px solid #dfe7e0;
      padding: 1.25rem;
      background: #fff;
      display: flex;
      flex-direction: column;
      gap: 0.65rem;
      min-height: 220px;
    }

    .feature-card-top {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      line-height: 1.2;
    }

    .feature-term {
      font-size: 0.65rem;
      color: #7f8e82;
      text-transform: uppercase;
      letter-spacing: 0.35em;
    }

    .feature-simple {
      font-size: 1.1rem;
      font-weight: 700;
      color: #1f3327;
    }

    .feature-card p {
      margin: 0;
      color: var(--gray-700);
      line-height: 1.6;
    }

    .feature-example {
      font-size: 0.9rem;
      color: #2c4132;
      font-style: italic;
    }

    .feature-importance {
      margin-top: auto;
      padding-top: 0.35rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.8rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: #4d6459;
    }

    .importance-meter {
      flex: 1;
      height: 6px;
      border-radius: 999px;
      background: #edf6ef;
      overflow: hidden;
    }

    .importance-fill {
      height: 100%;
      border-radius: inherit;
      background: linear-gradient(90deg, #6b9080, #7fa693);
      display: block;
    }

    .table-card {
      margin-top: 2rem;
      padding: 1.75rem 1.5rem;
      width: 100%;
    }

    #adjustment-stats-table {
      width: 100%;
      min-height: 360px;
      border-radius: 1rem;
      border: 1px solid #dae4da;
      overflow: hidden;
    }

    #adjustment-stats-table .tabulator-header {
      background: linear-gradient(120deg, #edf6ef 0%, #dfece1 100%);
    }

    #adjustment-stats-table .tabulator-col {
      color: #2b3b33;
      font-weight: 600;
    }

    #adjustment-stats-table .tabulator-row:nth-child(even) {
      background: #fafdf9;
    }

    .table-footer {
      margin-top: 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      font-size: 0.9rem;
      color: var(--gray-600);
      justify-content: space-between;
    }

    .table-footer span {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
    }

    @media (max-width: 768px) {
      .methodology-hero {
        padding: 2.25rem 1.5rem;
      }

      .hero-top-line {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
{% endblock %}

{% block page_title %}Valuation Methodology — OpenSkagit{% endblock %}

{% block content %}
  <section class="card methodology-hero">
    <div class="hero-top-line">
      <span>OpenSkagit.com</span>
      <span>AI-Enhanced Data Portal for Skagit County</span>
    </div>
    <h1>Trustworthy valuations start with transparent data.</h1>
    <p>
      Every number on this page is drawn from the most recent regression run, reflecting {{ adjustment_run_stats|length }}
      market tiers and {{ total_observations|intcomma }} verified residential sales. The interactive diagnostics below let
      you explore how each community scores on COD, PRD, R², and the median ratio.
    </p>
    <p class="hero-note">
      {% if last_updated %}
        Updated {{ last_updated|date:"F j, Y g:i A" }} with the latest verified sales.
      {% else %}
        Awaiting the first adjustment run.
      {% endif %}
    </p>
    <div class="hero-metrics">
      <article class="hero-metric">
        <div class="hero-metric-label">Sales analyzed</div>
        <div class="hero-metric-value">{{ total_observations|intcomma }}</div>
        <div class="hero-metric-note">Residential transactions in the current window</div>
      </article>
      <article class="hero-metric">
        <div class="hero-metric-label">Active segments</div>
        <div class="hero-metric-value">{{ adjustment_run_stats|length }}</div>
        <div class="hero-metric-note">Tiered regressions in this run</div>
      </article>
      <article class="hero-metric">
        <div class="hero-metric-label">Latest refresh</div>
        <div class="hero-metric-value">
          {% if last_updated %}
            {{ last_updated|date:"M j, Y" }}
          {% else %}
            TBD
          {% endif %}
        </div>
        <div class="hero-metric-note">Timestamp stamped on this run</div>
      </article>
    </div>
  </section>

  <section class="card trust-section">
    <div>
      <p class="section-eyebrow">Trusted data pipeline</p>
      <h2>We make every step auditable.</h2>
      <p>
        The regression engine trims outliers, balances value tiers, calibrates for price bias, and rebalances
        weights before publishing diagnostics. This page keeps every coefficient and metric accessible so
        property owners and assessors can verify consistency in Skagit County.
      </p>
      <ul class="trust-list">
        <li>Every record is a verified sale, and the engine documents which neighborhoods were included.</li>
        <li>Metrics like COD, PRD, and median ratio are surfaced for each market group to show how uniform the model is.</li>
        <li>Latest runs carry a unique ID and timestamp so stakeholders can reference the exact data set that produced the numbers.</li>
      </ul>
    </div>
    <div class="trust-pill-grid">
      <div class="trust-pill">
        <span>Run segments</span>
        <strong>{{ adjustment_run_stats|length }}</strong>
        <p>Market tiers modeled this round</p>
      </div>
      <div class="trust-pill">
        <span>Sales ingested</span>
        <strong>{{ total_observations|intcomma }}</strong>
        <p>Verified residential sales driving the model</p>
      </div>
      <div class="trust-pill">
        <span>Latest refresh</span>
        <strong>
          {% if last_updated %}
            {{ last_updated|date:"M j, Y" }}
          {% else %}
            TBD
          {% endif %}
        </strong>
        <p>Timestamp stamped on this run</p>
      </div>
      <div class="trust-pill">
        <span>Run ID</span>
        <strong>
          {% if latest_adjustment_run %}
            {{ latest_adjustment_run.run_id }}
          {% else %}
            Pending
          {% endif %}
        </strong>
        <p>Identifier for the current diagnostics</p>
      </div>
    </div>
  </section>

  <section class="card feature-section">
    <div class="section-head">
      <div>
        <p class="section-eyebrow">Features explained</p>
        <h2>Predictors that power the regression</h2>
      </div>
      <p class="section-subtitle">
        Each card defines a predictor, why it matters, and a homeowner-friendly example so the math feels grounded.
      </p>
    </div>
    <div class="feature-grid">
      {% for feature in feature_explanations %}
        <article class="feature-card">
          <div class="feature-card-top">
            <strong class="feature-simple">{{ feature.simple }}</strong>
            <span class="feature-term">{{ feature.term }}</span>
          </div>
          <p>{{ feature.explanation }}</p>
          <p class="feature-example"><strong>Example:</strong> {{ feature.example }}</p>
          {% if feature.importance %}
            <div class="feature-importance">
              <span>{{ feature.importance.label }}</span>
              <div class="importance-meter">
                <span class="importance-fill" style="width: {{ feature.importance.percent }}%;"></span>
              </div>
              <span>{{ feature.importance.percent|floatformat:1 }}%</span>
            </div>
          {% endif %}
        </article>
      {% endfor %}
    </div>
  </section>

  <section class="card table-card">
    <div class="section-head">
      <div>
        <p class="section-eyebrow">Interactive diagnostics</p>
        <h2>Latest adjustment run statistics</h2>
      </div>
      <p class="section-subtitle">
        Sort, search, and compare the newest diagnostics courtesy of Tabulator.js. Every row represents a defined
        market and value tier with its performance metrics.
      </p>
    </div>
    <div id="adjustment-stats-table" aria-live="polite"></div>
    <script id="methodology-run-stats-data" type="application/json">
      {{ adjustment_run_stats_json|safe }}
    </script>
    <div class="table-footer">
      {% if latest_adjustment_run %}
        <span>Run {{ latest_adjustment_run.run_id }}</span>
        <span>Refreshed {{ latest_adjustment_run.created_at|date:"F j, Y g:i A" }}</span>
        <span>{{ adjustment_run_stats|length }} rows</span>
      {% else %}
        <span>Adjustment run data is still being prepared.</span>
      {% endif %}
    </div>
  </section>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  if (typeof Tabulator === "undefined") {
    console.warn("Tabulator.js is not available on this page.");
    return;
  }

  const dataElement = document.getElementById("methodology-run-stats-data");
  let diagnostics = [];
  try {
    diagnostics = dataElement ? JSON.parse(dataElement.textContent || "[]") : [];
  } catch (error) {
    diagnostics = [];
    console.error("Failed to parse adjustment run stats JSON.", error);
  }

  const integerFormatter = new Intl.NumberFormat("en-US");
  const currencyFormatter = new Intl.NumberFormat("en-US", {
    style: "currency",
    currency: "USD",
    maximumFractionDigits: 0,
  });

  const formatNumber = (value) => {
    if (value === null || value === undefined || Number.isNaN(Number(value))) {
      return "—";
    }
    return integerFormatter.format(Number(value));
  };

  const formatDecimal = (value, precision = 3) => {
    if (value === null || value === undefined || Number.isNaN(Number(value))) {
      return "—";
    }
    return Number(Number(value)).toFixed(precision);
  };

  const formatPriceRange = (row) => {
    if (!row || row.price_min == null || row.price_max == null) {
      return "—";
    }
    const min = Number(row.price_min);
    const max = Number(row.price_max);
    if (Number.isNaN(min) || Number.isNaN(max)) {
      return "—";
    }
    return `${currencyFormatter.format(min)} — ${currencyFormatter.format(max)}`;
  };

  new Tabulator("#adjustment-stats-table", {
    data: diagnostics,
    layout: "fitDataStretch",
    responsiveLayout: "collapse",
    placeholder: "No adjustment diagnostics recorded yet.",
    columns: [
      { title: "Market group", field: "market_group", sorter: "string", hozAlign: "left" },
      { title: "Value tier", field: "value_tier", sorter: "string", hozAlign: "center" },
      {
        title: "Sales",
        field: "n",
        sorter: "number",
        hozAlign: "right",
        formatter: (cell) => formatNumber(cell.getValue()),
      },
      {
        title: "R²",
        field: "r2",
        sorter: "number",
        hozAlign: "right",
        formatter: (cell) => formatDecimal(cell.getValue(), 3),
      },
      {
        title: "Adj R²",
        field: "adj_r2",
        sorter: "number",
        hozAlign: "right",
        formatter: (cell) => formatDecimal(cell.getValue(), 3),
      },
      {
        title: "COD",
        field: "COD",
        sorter: "number",
        hozAlign: "right",
        formatter: (cell) => `${formatDecimal(cell.getValue(), 2)}%`,
      },
      {
        title: "PRD",
        field: "PRD",
        sorter: "number",
        hozAlign: "right",
        formatter: (cell) => formatDecimal(cell.getValue(), 3),
      },
      {
        title: "PRB",
        field: "PRB",
        sorter: "number",
        hozAlign: "right",
        formatter: (cell) => formatDecimal(cell.getValue(), 3),
      },
      {
        title: "Median ratio",
        field: "median_ratio",
        sorter: "number",
        hozAlign: "right",
        formatter: (cell) => formatDecimal(cell.getValue(), 3),
      },
      {
        title: "Range",
        field: "price_min",
        sorter: "number",
        hozAlign: "right",
        formatter: (cell) => formatPriceRange(cell.getRow().getData()),
      },
    ],
  });
});
</script>
{% endblock %}
